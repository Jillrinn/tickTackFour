# Requirements Document

## はじめに

本要件書は、ONEmore Turnマルチプレイヤーゲームタイマーのフロントエンド単体テストで発生している16ファイル90テストの失敗を体系的に修正するための要件を定義する。

現在の状態:
- **Test Files**: 16 failed | 41 passed (57)
- **Tests**: 90 failed | 457 passed (547)

目標の状態:
- **Test Files**: 57 passed (57) - 0 failed
- **Tests**: 547 passed (547) - 0 failed

失敗の主な原因は、`GameTimer.tsx`における実装不具合（`{false &&`による非表示、状態管理ロジックの問題、タイマー更新ロジックの不具合等）である。これらを修正し、全てのテストが成功する状態を実現することで、フロントエンドコードベースの品質を保証し、継続的インテグレーションの信頼性を向上させる。

## 要件

### 要件1: タイマーモードトグル表示機能の修正

**目的:** 開発者として、タイマーモードトグルスイッチUIが正常に表示・動作することで、ユーザーがカウントアップ/カウントダウンモードを切り替えられるようにしたい

**対応する失敗テスト**: 5件 (`GameTimer.conditionalRendering.test.tsx`)

#### 受け入れ基準

1. WHEN ユーザーがGameTimerコンポーネントを表示する THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチ(data-testid="timer-mode-toggle")を表示する

2. WHEN ユーザーがカウントアップモードを選択する THEN ゲームタイマーシステム SHALL カウントダウン秒数設定UIを非表示にする

3. WHEN ユーザーがカウントダウンモードを選択する THEN ゲームタイマーシステム SHALL カウントダウン秒数設定UIを表示する

4. WHEN ユーザーがタイマーモードを切り替える THEN ゲームタイマーシステム SHALL 関連UI要素の表示・非表示を即座に切り替える

5. WHEN ユーザーがカウントダウンモードからカウントアップモードに切り替える THEN ゲームタイマーシステム SHALL カウントダウン秒数の設定値を保持する

6. WHERE `GameTimer.tsx`のレンダリングロジック THE ゲームタイマーシステム SHALL `{false &&`のような常にfalseとなる条件分岐を含まない

### 要件2: ゲーム状態管理とボタン表示の修正

**目的:** 開発者として、ゲーム状態（未開始/進行中/一時停止）に応じて適切なボタンが表示・有効化されることで、ユーザーが直感的にゲームを操作できるようにしたい

**対応する失敗テスト**: 7件 (`GameTimer.buttonLayout.test.tsx`: 4件, `GameTimer.buttonStates.test.tsx`: 3件)

#### 受け入れ基準

1. WHEN ゲームが未開始の状態である THEN ゲームタイマーシステム SHALL 「ゲームを開始する」ボタンを固定ヘッダーに表示する

2. WHEN ゲームが開始済みの状態である THEN ゲームタイマーシステム SHALL 「次のプレイヤーへ →」ボタンを固定ヘッダーに表示する

3. WHEN 「次のプレイヤーへ →」ボタンが表示される THEN ゲームタイマーシステム SHALL aria-label="次のプレイヤーに切り替え"属性を設定する

4. WHEN 固定ヘッダーが表示される THEN ゲームタイマーシステム SHALL 一時停止ボタンと次のプレイヤーボタンの両方を表示する

5. WHEN ゲームが開始される THEN ゲームタイマーシステム SHALL 一時停止ボタンをenabled状態にする

6. WHEN ゲームが開始される THEN ゲームタイマーシステム SHALL activePlayerIndexを0に設定する

7. WHEN リセットボタンがクリックされる THEN ゲームタイマーシステム SHALL 一時停止ボタンをdisabled状態に戻す

8. WHEN リセットボタンがクリックされる THEN ゲームタイマーシステム SHALL 次のプレイヤーボタンのテキストを「ゲームを開始する」に戻す

9. WHEN 「次のプレイヤーへ →」ボタンがクリックされる THEN ゲームタイマーシステム SHALL ターン切り替えを即座に実行する

### 要件3: ゲーム全体時間表示機能の修正

**目的:** 開発者として、ゲーム全体の経過時間がリアルタイムで正確に表示されることで、ユーザーがゲームの進行状況を把握できるようにしたい

**対応する失敗テスト**: 9件 (`GameTimer.totalGameTime.test.tsx`: 6件, `GameTimer.totalPlayTime.test.tsx`: 3件)

#### 受け入れ基準

1. WHILE ゲームが進行中である THE ゲームタイマーシステム SHALL ゲーム全体時間を1秒ごとに更新する

2. WHEN ゲームが1秒経過する THEN ゲームタイマーシステム SHALL ゲーム全体時間を00:01に更新する

3. WHEN ゲームが5秒経過する THEN ゲームタイマーシステム SHALL ゲーム全体時間を00:05に更新する

4. WHEN プレイヤーが切り替わる THEN ゲームタイマーシステム SHALL ゲーム全体時間の更新を継続する

5. WHEN ゲームが一時停止される THEN ゲームタイマーシステム SHALL ゲーム全体時間の更新を停止する

6. WHEN ゲームが再開される THEN ゲームタイマーシステム SHALL ゲーム全体時間の更新を再開する

7. WHEN リセットボタンがクリックされる THEN ゲームタイマーシステム SHALL ゲーム全体時間を00:00にリセットする

8. WHEN カウントダウンモードが選択されている AND ゲームが進行中である THEN ゲームタイマーシステム SHALL ゲーム全体時間を減少させる

9. WHEN ゲーム全体時間が1時間以上になる THEN ゲームタイマーシステム SHALL HH:MM:SS形式で表示する

10. WHEN ゲーム全体時間が1時間以上2時間未満になる THEN ゲームタイマーシステム SHALL 警告色(warning)クラスを適用する

11. WHEN ゲーム全体時間が2時間以上になる THEN ゲームタイマーシステム SHALL 危険色(danger)クラスを適用する

12. WHEN ゲームが一時停止される THEN ゲームタイマーシステム SHALL ゲーム全体時間の表示を維持する

### 要件4: タイマーモード変更制御の修正

**目的:** 開発者として、ゲーム開始後や一時停止中にタイマーモード変更が適切に制御されることで、ゲーム途中での不正なモード変更を防止したい

**対応する失敗テスト**: 11件 (`GameTimer.timerModeUpdate.test.tsx`)

#### 受け入れ基準

1. WHEN ゲームが開始済みの状態である THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチをdisabled状態にする

2. WHEN ゲームが開始済みの状態である AND タイマーモードトグルスイッチにマウスホバーする THEN ゲームタイマーシステム SHALL 「ゲーム開始後はタイマーモードを変更できません」ツールチップを表示する

3. WHEN ゲームが一時停止中の状態である THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチをdisabled状態に維持する

4. WHEN いずれかのプレイヤーの経過時間が0より大きい THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチをdisabled状態にする

5. WHEN ゲームが未開始の状態である THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチをenabled状態にする

6. WHEN リセットボタンがクリックされる THEN ゲームタイマーシステム SHALL タイマーモードトグルスイッチをenabled状態に戻す

7. WHEN ゲーム開始後にカウントダウン秒数入力にマウスホバーする THEN ゲームタイマーシステム SHALL ツールチップを表示する

8. WHEN リセット後にカウントダウン秒数入力にマウスホバーする THEN ゲームタイマーシステム SHALL ツールチップを非表示にする

### 要件5: UI状態伝達の修正

**目的:** 開発者として、一時停止状態がボタンテキストで明確に伝達されることで、ユーザーが現在の状態を理解しやすくしたい

**対応する失敗テスト**: 2件 (`GameTimer.uiSimplification.test.tsx`)

#### 受け入れ基準

1. WHEN ゲームが一時停止中である THEN ゲームタイマーシステム SHALL 一時停止ボタンのテキストを「▶️ タイマー再開」に変更する

2. WHEN ゲームが進行中である THEN ゲームタイマーシステム SHALL 一時停止ボタンのテキストを「⏸️ タイマー停止」に変更する

3. WHEN UI簡素化後も THEN ゲームタイマーシステム SHALL 全ての必要な機能（開始、停止、再開、リセット、ターン切り替え）を利用可能にする

### 要件6: カウントダウンモード関連の修正

**目的:** 開発者として、カウントダウンモード特有の機能が正常に動作することで、カウントダウンモードを使用するユーザーに一貫した体験を提供したい

**対応する失敗テスト**: 2件 (`PlayerList.test.tsx`: 1件, `useServerGameState.test.ts`: 1件)

#### 受け入れ基準

1. WHEN カウントダウンモードが選択されている AND プレイヤーの残り時間が0以下になる THEN ゲームタイマーシステム SHALL 該当プレイヤーを赤色表示する

2. WHEN カウントダウンモードが選択されている AND 最長時間プレイヤーを取得する THEN ゲームタイマーシステム SHALL nullを返す

### 要件7: テスト品質保証とリグレッション防止

**目的:** 開発者として、全ての既存テストが成功する状態を維持することで、コードベースの品質を保証し、将来的なリグレッションを防止したい

#### 受け入れ基準

1. WHEN `npm test`コマンドが実行される THEN ゲームタイマーシステム SHALL 全57テストファイル、547テストが成功する

2. WHEN テスト修正が完了する THEN ゲームタイマーシステム SHALL 0件の失敗テストを持つ

3. WHERE 既存の機能実装 THE ゲームタイマーシステム SHALL 破壊的変更を含まない

4. WHEN E2Eテストが実行される THEN ゲームタイマーシステム SHALL 全てのE2Eテストが成功する

5. WHERE 他の仕様（player-name-default-standardization、e2e-page-object-fixes等） THE ゲームタイマーシステム SHALL 影響を与えない

## 制約条件

1. **既存機能の保護**: 既存機能の動作を変更しない。テストを成功させるための修正は、実装の不具合を修正するものであり、機能の変更ではない。

2. **TDD原則の遵守**: 既存テストケースを修正の指針とし、テストが期待する動作を実装する。テストケースを変更してパスさせることは許可されない（テストケース自体が誤っている場合を除く）。

3. **リグレッション禁止**: 他の仕様や機能に影響を与えず、修正対象の90テスト以外のテストは引き続き成功する状態を維持する。

4. **段階的修正**: カテゴリ別（timer-mode-toggle、ボタン状態管理、ゲーム全体時間等）に段階的に修正を進め、各段階で該当するテストが成功することを確認する。

5. **コードベース一貫性**: 修正後のコードは、既存のコードスタイル、命名規則、アーキテクチャパターンに従う。
