# 実装計画: フロントエンド単体テスト失敗修正

**注意**: 要件1（タイマーモードトグル表示機能）に関連する5件のテストは現在無効化されているため、本実装の対象外とする。要件1は`countdown-mode-fix`仕様のPhase 0.5で対応予定。

**対象**: 要件2-6に関連する31件のテスト失敗を修正

**関連仕様**: `countdown-mode-fix` - Phase 0.5でタイマーモードUI復元後、要件1のテストを有効化

### TDD実装プロセス（必須）
本仕様では既存のテストケースが失敗している状態からスタートするため、以下のTDD修正プロセスに従うこと：

1. **RED phase**: 既存テストが失敗している状態を確認（テストケースは既に存在）
2. **GREEN phase**: 実装を修正して既存テストをパスさせる
3. **REFACTOR phase**: 必要に応じてリファクタリング（テストは引き続きパス）
4. `npm test`で全テストが成功することを確認

### TDD Implementation Process (Required)
Since existing test cases are failing, follow this TDD fix process:

1. **RED phase**: Confirm existing tests are failing (test cases already exist)
2. **GREEN phase**: Fix implementation to make existing tests pass
3. **REFACTOR phase**: Refactor as needed (tests continue to pass)
4. Run `npm test` to verify all tests pass

## Phase 1: ボタン表示と状態管理の修正（要件2）

- [ ] 1. ゲームコントロールボタンの表示と状態管理を修正する
- [ ] 1.1 ゲーム状態に基づくボタン表示を修正する
  - ゲーム未開始時に「ゲームを開始する」ボタンを固定ヘッダーに表示
  - ゲーム開始後に「次のプレイヤーへ →」ボタンを固定ヘッダーに表示
  - 固定ヘッダーに一時停止ボタンと次のプレイヤーボタンの両方を表示
  - 次のプレイヤーボタンクリック時にターン切り替えが即座に実行される
  - _Requirements: 2.1, 2.2, 2.4, 2.9_

- [ ] 1.2 ボタンのアクセシビリティと状態管理を修正する
  - 「次のプレイヤーへ →」ボタンにaria-label="次のプレイヤーに切り替え"を設定
  - ゲーム開始後、一時停止ボタンをenabled状態にする
  - ゲーム開始時にactivePlayerIndexを0に設定する
  - リセットボタンクリック後、一時停止ボタンをdisabled状態に戻す
  - リセットボタンクリック後、次のプレイヤーボタンのテキストを「ゲームを開始する」に戻す
  - _Requirements: 2.3, 2.5, 2.6, 2.7, 2.8_

- [ ] 1.3 ボタン表示・状態管理のテストを検証する
  - `npm test GameTimer.buttonLayout.test.tsx`を実行（4テスト）
  - `npm test GameTimer.buttonStates.test.tsx`を実行（3テスト）
  - 全7テストがパスすることを確認
  - `npm test`で既存の成功テストにリグレッションがないことを確認
  - _Requirements: 2.1-2.9, 7.1, 7.3_

## Phase 2: ゲーム全体時間表示の修正（要件3）

- [ ] 2. ゲーム全体時間のトラッキングと表示を修正する
- [ ] 2.1 ゲーム全体時間の更新メカニズムを修正する
  - ゲーム進行中に全体時間を1秒ごとに更新する
  - useEffectの依存配列を正しく設定（isPaused, isGameActive, timerMode含む）
  - setIntervalのクリーンアップを正しく実装（React 18 Strict Mode対応）
  - 一時停止時に全体時間の更新を停止する
  - 再開時に全体時間の更新を再開する
  - プレイヤー切り替え時も全体時間の更新を継続する
  - リセット時に全体時間を00:00にリセットする
  - カウントダウンモード時に全体時間を減少させる
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_

- [ ] 2.2 ゲーム全体時間の表示形式と状態インジケーターを修正する
  - 1時間未満はMM:SS形式で表示
  - 1時間以上はHH:MM:SS形式で表示
  - 1時間以上2時間未満の場合に警告色(warning)クラスを適用
  - 2時間以上の場合に危険色(danger)クラスを適用
  - 一時停止中も全体時間の表示を維持する
  - _Requirements: 3.9, 3.10, 3.11, 3.12_

- [ ] 2.3 ゲーム全体時間のテストを検証する
  - `npm test GameTimer.totalGameTime.test.tsx`を実行（6テスト）
  - `npm test GameTimer.totalPlayTime.test.tsx`を実行（3テスト）
  - 全9テストがパスすることを確認
  - `npm test`で既存の成功テストにリグレッションがないことを確認
  - _Requirements: 3.1-3.12, 7.1, 7.3_

## Phase 3: タイマーモード変更制御の修正（要件4）

- [ ] 3. タイマーモード変更の制御ロジックを修正する
- [ ] 3.1 ゲーム状態に基づくタイマーモードトグルの無効化を修正する
  - ゲーム開始後（isGameStarted = true）にタイマーモードトグルをdisabled状態にする
  - 一時停止中もタイマーモードトグルをdisabled状態に維持する
  - いずれかのプレイヤーの経過時間が0より大きい場合にタイマーモードトグルをdisabled状態にする
  - ゲーム未開始時にタイマーモードトグルをenabled状態にする
  - リセットボタンクリック後にタイマーモードトグルをenabled状態に戻す
  - _Requirements: 4.1, 4.3, 4.4, 4.5, 4.6_

- [ ] 3.2 タイマーモード変更制限のツールチップ表示を実装する
  - ゲーム開始後のタイマーモードトグルマウスホバー時に「ゲーム開始後はタイマーモードを変更できません」ツールチップを表示
  - ゲーム開始後のカウントダウン秒数入力マウスホバー時にツールチップを表示
  - リセット後にカウントダウン秒数入力のツールチップを非表示にする
  - _Requirements: 4.2, 4.7, 4.8_

- [ ] 3.3 タイマーモード変更制御のテストを検証する
  - `npm test GameTimer.timerModeUpdate.test.tsx`を実行（11テスト）
  - 全11テストがパスすることを確認
  - `npm test`で既存の成功テストにリグレッションがないことを確認
  - _Requirements: 4.1-4.8, 7.1, 7.3_

## Phase 4: UI状態伝達の修正（要件5）

- [ ] 4. 一時停止状態のUI伝達を修正する
- [ ] 4.1 一時停止ボタンのテキストで状態を伝達する
  - ゲーム進行中（isPaused = false）に一時停止ボタンのテキストを「⏸️ タイマー停止」に設定
  - 一時停止中（isPaused = true）に一時停止ボタンのテキストを「▶️ タイマー再開」に設定
  - UI簡素化後も全ての必要な機能（開始、停止、再開、リセット、ターン切り替え）を利用可能にする
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 4.2 UI状態伝達のテストを検証する
  - `npm test GameTimer.uiSimplification.test.tsx`を実行（2テスト）
  - 全2テストがパスすることを確認
  - `npm test`で既存の成功テストにリグレッションがないことを確認
  - _Requirements: 5.1-5.3, 7.1, 7.3_

## Phase 5: カウントダウンモード関連の修正（要件6）

- [ ] 5. カウントダウンモード特有の表示と動作を修正する
- [ ] 5.1 カウントダウンモード時のプレイヤー表示を修正する
  - カウントダウンモード選択時、残り時間が0以下のプレイヤーを赤色表示する
  - PlayerList.tsxの条件分岐ロジックを修正
  - _Requirements: 6.1_

- [ ] 5.2 カウントダウンモード時の最長時間プレイヤー取得を修正する
  - カウントダウンモード選択時、最長時間プレイヤーの取得でnullを返す
  - useServerGameState.tsのgetLongestTimePlayer関数を修正
  - _Requirements: 6.2_

- [ ] 5.3 カウントダウンモード関連のテストを検証する
  - `npm test PlayerList.test.tsx`を実行（1テスト）
  - `npm test useServerGameState.test.ts`を実行（1テスト）
  - 全2テストがパスすることを確認
  - `npm test`で既存の成功テストにリグレッションがないことを確認
  - _Requirements: 6.1, 6.2, 7.1, 7.3_

## Phase 6: 最終検証と実装完了

- [ ] 6. 全テストの最終検証と実装完了処理を実施する
- [ ] 6.1 全単体テストの実行と検証
  - `npm test`を実行
  - 全テストファイルが成功することを確認
  - 全テストが成功することを確認
  - 要件2-6に関連する31テストが全て成功していることを確認
  - 既存の成功テストにリグレッションが発生していないことを確認
  - _Requirements: 7.1, 7.2_

- [ ] 6.2 E2Eテストの実行と検証
  - `npx playwright test`を実行
  - 全E2Eテストが成功することを確認
  - ブラウザでの実機動作確認
  - エラーや予期しない動作が発生しないことを確認
  - _Requirements: 7.4_

- [ ] 6.3 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _Requirements: 7.5_
  - _Note: 要件1は countdown-mode-fix Phase 0.5 で対応予定_
