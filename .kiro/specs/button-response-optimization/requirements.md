# Requirements Document

## Introduction

マルチプレイヤーゲームタイマーにおいて、各ボタン押下時のレスポンス時間が遅く、ユーザーがストレスを感じる状態となっています。現在の実装では、**ボタンクリック後にAPIレスポンスを待機し、さらにポーリング処理（5秒間隔）でのみ画面が更新される**ため、最悪5秒以上画面が反応しない問題が発生しています。

本機能では、**各ボタンクリック後に即座にサーバーから最新状態を取得して画面をリフレッシュ**することで、APIラウンドトリップ時間内（100-200ms程度）での視覚的フィードバックを実現し、ストレスフリーな操作感を提供します。

### ビジネス価値
- **ユーザー体験の劇的改善**: 現在の「最悪5秒待ち」から「100-200ms応答」へ大幅改善
- **操作の確実性**: ボタンクリックが即座に画面に反映され、操作が受け付けられたことを認識可能
- **継続利用率の向上**: 快適な操作感により継続的な利用を促進

### 根本原因の分析
**現在の問題**:
1. ボタンクリック → API呼び出し（await）→ **ポーリング処理（5秒間隔）を待機** → 画面更新
2. ポーリング処理でのみ`serverGameState.updateFromServer()`が呼ばれるため、ボタンクリック後に最大5秒間画面が更新されない

**ソリューション**:
各ボタンクリック後に即座に`/api/game`をfetchして`serverGameState.updateFromServer()`を呼び出し、ポーリングを待たずに画面をリフレッシュ

## Requirements

### Requirement 1: ボタンクリック時の即座の画面更新

**Objective:** ユーザーとして、ボタンをクリックした際にAPIラウンドトリップ時間内（100-200ms）で視覚的フィードバックが得られることで、操作が受け付けられたことを確実に認識できる

#### Acceptance Criteria

1. WHEN ユーザーが「次のプレイヤーへ」ボタンをクリック THEN ゲームタイマーアプリケーション SHALL API呼び出し完了後、**即座に/api/gameから最新状態を取得**し、200ms以内にアクティブプレイヤーの切り替え表示を提供する

2. WHEN ユーザーが「一時停止」または「再開」ボタンをクリック THEN ゲームタイマーアプリケーション SHALL API呼び出し完了後、**即座に/api/gameから最新状態を取得**し、200ms以内にボタンの状態変更とタイマー停止/開始を反映する

3. WHEN ユーザーが「リセット」ボタンをクリック THEN ゲームタイマーアプリケーション SHALL API呼び出し完了後、**即座に/api/gameから最新状態を取得**し、200ms以内に全プレイヤーの時間とゲーム状態をリセットして表示する

4. WHEN ユーザーがプレイヤー人数を変更（4〜6人のドロップダウン選択） THEN ゲームタイマーアプリケーション SHALL API呼び出し完了後、**即座に/api/gameから最新状態を取得**し、200ms以内にプレイヤーリストのUI更新を完了する

5. WHEN ユーザーがタイマーモード（カウントアップ/カウントダウン）を切り替え THEN ゲームタイマーアプリケーション SHALL API呼び出し完了後、**即座に/api/gameから最新状態を取得**し、200ms以内にタイマー表示とUI要素を更新する

6. IF ボタンクリックから視覚的フィードバックまでのレスポンス時間が300msを超えた場合 THEN ゲームタイマーアプリケーション SHALL パフォーマンス警告をコンソールに記録する

7. WHEN API呼び出しが失敗した場合 THEN ゲームタイマーアプリケーション SHALL ユーザーにエラーメッセージを表示し、画面状態を変更前に維持する

### Requirement 2: UI更新の最適化

**Objective:** 開発者として、不必要なコンポーネント再レンダリングを排除することで、UIの応答性を最大化し、スムーズな操作感を実現する

#### Acceptance Criteria

1. WHEN ゲーム状態が更新された際 THEN ゲームタイマーアプリケーション SHALL 状態変更の影響を受けるコンポーネントのみを再レンダリングする

2. WHERE プレイヤーリストコンポーネント（PlayerList）が表示されている場合 THE ゲームタイマーアプリケーション SHALL React.memoまたはuseMemoを使用して、プロパティが変更されていないプレイヤーカードの再レンダリングを防止する

3. WHERE コントロールボタン（PrimaryControls、SettingsControls）が配置されている場合 THE ゲームタイマーアプリケーション SHALL useCallbackを使用してイベントハンドラをメモ化し、子コンポーネントの不要な再レンダリングを防止する

4. WHEN タイマーが1秒ごとに更新される際 THEN ゲームタイマーアプリケーション SHALL タイマー表示部分のみを再レンダリングし、他のUI要素の再レンダリングを発生させない

5. IF コンポーネントが連続して3回以上同じプロパティで再レンダリングされた場合 THEN ゲームタイマーアプリケーション SHALL 開発モードで警告を表示し、最適化の必要性を開発者に通知する

### Requirement 3: サーバー状態同期の最適化

**Objective:** 開発者として、ボタンクリック後に即座にサーバーから最新状態を取得して画面をリフレッシュすることで、ポーリング間隔（5秒）を待たずにUI更新を実現する

#### Acceptance Criteria

1. WHEN ユーザーがボタンをクリックした際 THEN ゲームタイマーアプリケーション SHALL API呼び出し（例: POST /api/switchTurn）完了後、**即座にGET /api/gameをfetch**して最新状態を取得する

2. WHEN GET /api/gameから最新状態を取得した際 THEN ゲームタイマーアプリケーション SHALL `serverGameState.updateFromServer()`を呼び出してUI状態を更新する

3. WHERE useServerGameStateフックが使用されている場合 THE ゲームタイマーアプリケーション SHALL 新しい`syncWithServer()`メソッドを提供し、任意のタイミングでサーバー状態を強制取得可能にする

4. WHEN ポーリング処理とボタンクリック後のsyncWithServer()が同時に発生した場合 THEN ゲームタイマーアプリケーション SHALL 重複リクエストを防止し、最新のリクエストのみを実行する

5. WHEN syncWithServer()が失敗した場合 THEN ゲームタイマーアプリケーション SHALL エラーをコンソールに記録し、ユーザーにエラーメッセージを表示する

6. WHEN ボタンクリックによる状態変更が発生した際 THEN ゲームタイマーアプリケーション SHALL API呼び出しとsyncWithServer()を直列で実行し、状態の一貫性を保証する

### Requirement 4: パフォーマンス計測と検証

**Objective:** 開発者として、レスポンス時間を定量的に計測し、最適化の効果を検証できるようにすることで、継続的なパフォーマンス改善を実現する

#### Acceptance Criteria

1. WHEN 開発モードでアプリケーションが実行されている場合 THEN ゲームタイマーアプリケーション SHALL Performance APIを使用して各ボタンクリックからUI更新完了までの時間を計測し、コンソールに記録する

2. WHEN ボタンクリックイベントが発生した際 THEN ゲームタイマーアプリケーション SHALL performance.mark()とperformance.measure()を使用してレスポンス時間の詳細な計測データを記録する

3. WHERE E2Eテスト環境（Playwright）が実行されている場合 THE ゲームタイマーアプリケーション SHALL 各ボタン操作のレスポンス時間を自動計測し、50msの目標値を超えた場合はテストを失敗させる

4. WHEN 最適化前後でパフォーマンス比較が必要な場合 THEN ゲームタイマーアプリケーション SHALL 主要操作（次のプレイヤーへ、一時停止、リセット）について、最適化前後のレスポンス時間の改善率を計測し、レポートとして出力する

5. WHERE React DevTools Profilerが利用可能な場合 THE ゲームタイマーアプリケーション SHALL コンポーネントのレンダリング時間と再レンダリング回数を記録し、ボトルネックの特定を可能にする

6. WHEN ユニットテストが実行される際 THEN ゲームタイマーアプリケーション SHALL useGameStateとuseGameTimerフックの状態更新処理について、同期的な更新が50ms以内に完了することを検証する
