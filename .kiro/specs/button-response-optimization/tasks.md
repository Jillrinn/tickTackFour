# 実装計画: ボタンレスポンス最適化

## Phase 1: サーバー状態同期機能の実装

### 1. サーバー状態の即座取得機能を実装する

- [x] 1.1 サーバー状態を強制的に取得するメソッドを実装
  - `/api/game` エンドポイントへのGETリクエスト送信
  - 取得した最新状態を内部状態管理システムに反映
  - 戻り値として最新状態またはnullを返す（Promise型）
  - TypeScript型定義: `Promise<GameStateWithTime | null>`
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 1.2 連続呼び出し防止機構を実装（デバウンス）
  - 100ms以内の連続呼び出しを自動的にキャンセル
  - タイマー管理用の参照を保持し、新しい呼び出し時に前回のタイマーをクリア
  - 最新の呼び出しのみを実際に実行
  - _Requirements: 3.4_

- [x] 1.3 重複リクエスト防止機構を実装
  - 実行中のリクエストがある場合、新しいリクエストをスキップ
  - リクエスト進行状態を追跡するフラグを管理
  - スキップされたリクエストはコンソールログに記録
  - リクエスト完了後、フラグを必ずリセット（finally句）
  - _Requirements: 3.4_

- [x] 1.4 エラーハンドリングを実装
  - ネットワークエラー発生時は静かに失敗させる
  - エラー内容をコンソールに記録（開発者向け）
  - 失敗時はnullを返し、ポーリング処理による最終的な整合性に依存
  - ユーザーへのエラー通知は行わない（UX妨害防止）
  - _Requirements: 3.5_

- [x] 1.5 ユニットテストを作成（TDD）
  - サーバー状態取得メソッドがAPIを正しく呼び出すことを検証
  - デバウンス機構が100ms以内の連続呼び出しをスキップすることを検証
  - 重複リクエスト防止機構が同時呼び出しをスキップすることを検証
  - エラーハンドリングが正しく動作することを検証（nullを返す）
  - fetch APIをモックして使用
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

## Phase 2: ボタンハンドラの統合

### 2. 主要操作ボタンの即座画面更新を実装

- [x] 2.1 ターン切り替えボタンの即座更新を実装
  - API呼び出し完了後、即座にサーバー状態を取得
  - ETag更新処理の後に画面リフレッシュを実行
  - エラーはコンソールログに記録し、静かに失敗
  - フォールバックモードでは既存動作を維持（変更なし）
  - _Requirements: 1.1, 3.1, 3.6_

- [x] 2.2 一時停止・再開ボタンの即座更新を実装
  - API呼び出し完了後、即座にサーバー状態を取得
  - 一時停止と再開の両方の状態変化に対応
  - タイマーの停止/開始が200ms以内に画面に反映されることを確保
  - _Requirements: 1.2, 3.1, 3.6_

- [x] 2.3 リセットボタンの即座更新を実装
  - API呼び出し完了後、即座にサーバー状態を取得
  - 全プレイヤーの時間リセットが200ms以内に画面に反映されることを確保
  - ゲーム状態の完全なリセットを視覚的に確認可能にする
  - _Requirements: 1.3, 3.1, 3.6_

### 3. 設定変更操作の即座画面更新を実装

- [ ] 3.1 プレイヤー人数変更の即座更新を実装
  - ドロップダウン選択変更時、API呼び出し完了後に即座にサーバー状態を取得
  - プレイヤーリストのUI更新が200ms以内に完了することを確保
  - 4〜6人の全パターンで動作確認
  - _Requirements: 1.4, 3.1, 3.6_

- [ ] 3.2 タイマーモード切り替えの即座更新を実装
  - カウントアップ/カウントダウン切り替え時、API呼び出し完了後に即座にサーバー状態を取得
  - タイマー表示とUI要素の更新が200ms以内に完了することを確保
  - モード切り替えによる視覚的変化を即座に反映
  - _Requirements: 1.5, 3.1, 3.6_

## Phase 3: テストと検証

### 4. E2Eテストでレスポンス時間を自動検証

- [ ] 4.1 ターン切り替えボタンのレスポンス時間テストを作成
  - ボタンクリックから画面更新までの時間をPerformance APIで計測
  - レスポンス時間が200ms以内であることを自動検証
  - テスト失敗時はレスポンス時間を明示的に報告
  - _Requirements: 1.1, 4.1, 4.2_

- [ ] 4.2 一時停止・再開ボタンのレスポンス時間テストを作成
  - 一時停止と再開の両方の操作でレスポンス時間を計測
  - それぞれ200ms以内であることを自動検証
  - タイマーの停止/開始が正しく反映されることも検証
  - _Requirements: 1.2, 4.1, 4.2_

- [ ] 4.3 リセットボタンのレスポンス時間テストを作成
  - リセット操作のレスポンス時間を計測
  - 200ms以内であることを自動検証
  - 全プレイヤーの時間が正しくリセットされることも検証
  - _Requirements: 1.3, 4.1, 4.2_

- [ ] 4.4 設定変更操作のレスポンス時間テストを作成
  - プレイヤー人数変更とタイマーモード切り替えのレスポンス時間を計測
  - それぞれ200ms以内であることを自動検証
  - UI要素が正しく更新されることも検証
  - _Requirements: 1.4, 1.5, 4.1, 4.2_

### 5. パフォーマンス計測機能を実装

- [ ] 5.1 開発モードでのパフォーマンス計測を実装
  - Performance APIを使用して各ボタンクリックのレスポンス時間を計測
  - performance.mark()とperformance.measure()で詳細データを記録
  - コンソールに計測結果を出力（開発者向け）
  - 300msを超えた場合は警告を表示
  - _Requirements: 1.6, 4.1, 4.2_

- [ ] 5.2 パフォーマンス改善効果の検証レポートを作成
  - 主要操作（次のプレイヤーへ、一時停止、リセット）の最適化前後のレスポンス時間を計測
  - 改善率を計算し、レポートとして出力
  - 目標値（200ms以内）の達成状況を確認
  - _Requirements: 4.4_

## Phase 4: 実装完了処理

### 6. 実装完了処理を実施する

- [ ] 6.1 全テスト結果の確認
  - 全てのユニットテストが成功していることを確認
  - 全てのE2Eテストが成功していることを確認
  - エラーや予期しない動作が発生しないことを確認

- [ ] 6.2 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
