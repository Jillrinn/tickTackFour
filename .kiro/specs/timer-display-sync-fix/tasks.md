# Implementation Plan

### TDD実装プロセス（必須）
各タスクの実装時は以下のTDDプロセスに従うこと：
1. **RED phase**: 実装前にテストケースを作成
2. **GREEN phase**: 最小限の実装でテストをパス
3. **REFACTOR phase**: 必要に応じてリファクタリング
4. `npm test`で全テストが成功することを確認

### TDD Implementation Process (Required)
Follow this TDD process for each task implementation:
1. **RED phase**: Create test cases before implementation
2. **GREEN phase**: Minimal implementation to pass tests
3. **REFACTOR phase**: Refactor as needed
4. Run `npm test` to verify all tests pass

## Phase 1: データモデル拡張

### 1. プレイヤーデータモデルに一時停止時間追跡機能を追加する

- [x] 1.1 各プレイヤーのターン中に累積された一時停止時間を追跡する機能を実装
  - プレイヤーデータモデルに累積一時停止時間を保存するフィールドを追加
  - 新規プレイヤー作成時に一時停止時間をゼロで初期化
  - データ構造が複数回の一時停止・再開サイクルをサポート
  - 既存のプレイヤーデータとの後方互換性を確保
  - _Requirements: 3.4, 3.6_

- [x] 1.2 データモデル変更の検証をユニットテストで実施
  - デフォルト一時停止時間の初期化をテスト
  - 一時停止時間のデータ型検証をテスト
  - 既存プレイヤーデータとの互換性を検証
  - _Requirements: 6.1_

## Phase 2: ターン時間計算ロジック実装

### 2. 一時停止期間を除外したターン時間計算機能を実装する

- [ ] 2.1 全ての一時停止期間を除外してターン時間を正確に計算
  - 経過時間から累積一時停止時間を差し引く計算を実装
  - ターンが開始していない場合はゼロを返す処理を実装
  - ゲームが現在一時停止中の場合は一時停止開始時刻を使用
  - 計算結果が常に非負の値を返すことを保証
  - _Requirements: 2.3, 2.4, 2.5, 3.3, 3.5_

- [ ] 2.2 ゲームの一時停止・再開時に一時停止期間を累積
  - ゲーム一時停止時に現在時刻を記録
  - ゲーム再開時に一時停止期間を計算
  - 一時停止期間をプレイヤーの累積一時停止時間に加算
  - 連続する複数回の一時停止・再開サイクルをサポート
  - _Requirements: 3.1, 3.2, 3.5_

- [ ] 2.3 新しいアクティブプレイヤーへの切り替え時に一時停止追跡をリセット
  - 新しいプレイヤーがアクティブになった際に累積一時停止時間をリセット
  - 前のプレイヤーのターン開始時刻をリセット
  - 新しいプレイヤーのターン開始時刻を現在時刻で初期化
  - 新しいターンでは常に一時停止時間がゼロから始まることを保証
  - _Requirements: 2.6, 3.6, 5.5_

### 3. ターン時間計算と一時停止機能のユニットテストを作成する

- [ ] 3.1 ターン時間計算の正確性を検証するユニットテスト
  - ターンが開始していない場合にゼロを返すことをテスト
  - ターン時間が累積一時停止時間を除外することをテスト
  - アクティブな一時停止中のターン時間計算をテスト
  - 複数回の一時停止・再開サイクルでのターン時間をテスト
  - ターン時間計算が常に非負の値を返すことをテスト
  - _Requirements: 6.1, 6.2_

- [ ] 3.2 一時停止・再開機能の正確性を検証するユニットテスト
  - 一時停止時に現在時刻を記録することをテスト
  - 再開時に一時停止期間を正しく累積することをテスト
  - 複数回の一時停止・再開サイクルで正しく累積されることをテスト
  - 一時停止期間が状態更新を通じて保持されることをテスト
  - _Requirements: 6.1_

## Phase 3: タイマー表示の同期実装

### 4. 全てのタイマー表示を同時に更新する統一メカニズムを実装する

- [ ] 4.1 全タイマー表示を同じタイミングで更新する単一のタイマー更新メカニズムを実装
  - 全ての表示をトリガーする単一のタイマー更新メカニズムを実装
  - 経過時間、ターン時間、合計時間、最長時間プレイヤーの全表示が同時に更新されることを保証
  - 更新頻度を1秒間隔で設定
  - 更新された時間値を表示するためのUI再描画をトリガー
  - _Requirements: 1.1-1.7, 4.1-4.6_

- [ ] 4.2 表示同期機能のユニットテストを作成
  - 全てのタイマー表示が単一の更新イベントから更新されることをテスト
  - 更新頻度が1秒であることをテスト
  - 各更新でUI再描画が発生することをテスト
  - 複数のタイマーインターバルが存在しないことを検証
  - _Requirements: 6.1_

## Phase 4: E2Eテストによる検証

### 5. タイマー表示同期と一時停止機能のE2Eテストを作成する

- [ ] 5.1 全タイマー表示が同じ秒数を表示することを検証するE2Eテスト
  - ゲームを開始してタイマーを動作させる
  - 全てのタイマー表示が同一の秒数を表示することを検証
  - 経過時間、ターン時間、合計時間が同期していることを検証
  - 最長時間プレイヤー表示が同期して更新されることを検証
  - _Requirements: 6.3_

- [ ] 5.2 一時停止・再開後にターン時間が正確に継続することを検証するE2Eテスト
  - ゲームを開始して数秒間タイマーを動作させる
  - ゲームを一時停止して数秒間待機
  - ゲームを再開してターン時間が一時停止時点から継続することを検証
  - 複数回の一時停止・再開サイクルを実行
  - 累積一時停止時間が正しく除外されることを検証
  - _Requirements: 6.4, 6.5_

- [ ] 5.3 既存のゲーム機能が修正後も正常に動作することを検証する回帰E2Eテスト
  - ゲームリセットで全タイマーがゼロにクリアされることを検証
  - プレイヤー切り替えで新しいプレイヤーのターン時間がリセットされることを検証
  - タイマーモード変更が正しく動作することを検証
  - プレイヤー数変更で合計時間が正しく再計算されることを検証
  - 最長時間プレイヤー表示が正しく動作することを検証
  - _Requirements: 6.6, 5.1-5.6_

## Phase 5: 実装完了処理

### 6. 実装完了処理を実施する

- [ ] 6.1 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _Requirements: 全要件の実装完了_
