# タイマーモード更新機能修正 - 実装タスク

## TDD実装プロセス（必須）

各タスクの実装時は以下のTDDプロセスに従うこと：
1. **RED phase**: 実装前にテストケースを作成
2. **GREEN phase**: 最小限の実装でテストをパス
3. **REFACTOR phase**: 必要に応じてリファクタリング
4. `npm test`で全テストが成功することを確認

## Phase 1: ゲーム状態判定ロジックの実装

- [ ] 1. ゲーム開始状態の判定機能を実装する
  - ゲームが開始されたかどうかを判定するロジックを作成
  - アクティブプレイヤーインデックスが-1でない場合は開始済みと判定
  - いずれかのプレイヤーの経過時間が0秒より大きい場合は開始済みと判定
  - 両方の条件を満たさない場合のみ未開始と判定
  - _Requirements: 1, 2_

- [ ] 1.1 ゲーム開始状態判定のユニットテストを作成
  - 未開始状態（activePlayerIndex = -1、全プレイヤー時間 = 0）のテストケース
  - 開始済み状態（activePlayerIndex = 0）のテストケース
  - 開始済み状態（いずれかのプレイヤー時間 > 0）のテストケース
  - フォールバックモードとAPIモードの両方で動作確認
  - _Requirements: 1, 2_

- [ ] 1.2 ゲーム開始状態判定ロジックを実装
  - GameTimerコンポーネント内にisGameStarted判定式を追加
  - フォールバックモード用の判定実装（gameState使用）
  - APIモード用の判定実装（serverGameState使用）
  - ユニットテストが全てパスすることを確認
  - _Requirements: 1, 2_

## Phase 2: タイマーモードトグルの無効化制御

- [ ] 2. タイマーモードトグルスイッチの無効化条件を修正する
  - ゲーム開始後はタイマーモードトグルを無効化
  - 一時停止中でも無効化状態を維持
  - ゲーム未開始時のみ有効化
  - リセット後は再度有効化
  - _Requirements: 1, 2, 3_

- [ ] 2.1 タイマーモードトグル無効化のユニットテストを作成
  - ゲーム未開始時の有効化テストケース
  - ゲーム開始後の無効化テストケース
  - 一時停止中の無効化テストケース
  - リセット後の有効化テストケース
  - _Requirements: 1, 2, 3_

- [ ] 2.2 タイマーモードトグルのdisabled属性を修正
  - 既存の`disabled={isGameActive && !isPaused}`を削除
  - 新しい`disabled={isGameStarted}`条件に置き換え
  - フォールバックモードとAPIモードの両方で動作確認
  - ユニットテストが全てパスすることを確認
  - _Requirements: 1, 2, 3_

## Phase 3: カウントダウン秒数入力の無効化制御

- [ ] 3. カウントダウン秒数入力フィールドの無効化条件を追加する
  - タイマーモードトグルと連動して無効化
  - ゲーム開始後は秒数変更を禁止
  - ゲーム未開始時のみ編集可能
  - UI一貫性を保つ
  - _Requirements: 5_

- [ ] 3.1 カウントダウン秒数入力無効化のユニットテストを作成
  - ゲーム未開始時の有効化テストケース
  - ゲーム開始後の無効化テストケース
  - カウントダウンモード時のみ表示されることを確認
  - _Requirements: 5_

- [ ] 3.2 カウントダウン秒数入力にdisabled属性を追加
  - `<input type="number">`要素にdisabled属性を追加
  - `disabled={isGameStarted}`条件を設定
  - カウントダウンモードが選択されている場合のみ表示
  - ユニットテストが全てパスすることを確認
  - _Requirements: 5_

## Phase 4: ツールチップ表示機能

- [ ] 4. 無効化時のツールチップを追加する
  - タイマーモードトグル無効化時に理由を表示
  - HTML標準のtitle属性を使用
  - 「ゲームをリセットしてからモードを変更してください」というメッセージ
  - カウントダウン秒数入力にも同じツールチップを追加
  - _Requirements: 2_

- [ ] 4.1 ツールチップ表示のユニットテストを作成
  - ゲーム開始後にtitle属性が存在することを確認
  - title属性のテキスト内容を検証
  - ゲーム未開始時はtitle属性が設定されないことを確認
  - _Requirements: 2_

- [ ] 4.2 タイマーモードトグルにtitle属性を追加
  - 条件付きtitle属性を実装（isGameStarted時のみ設定）
  - メッセージテキストを日本語で設定
  - カウントダウン秒数入力にも同じtitle属性を追加
  - ユニットテストが全てパスすることを確認
  - _Requirements: 2_

## Phase 5: リセット機能との統合

- [ ] 5. リセット後のタイマーモード有効化を確認する
  - リセットボタンクリック後にタイマーモードトグルが有効化
  - リセットボタンクリック後にカウントダウン秒数入力が有効化
  - 既存のリセット機能が正常に動作することを確認
  - フォールバックモードとAPIモードの両方で動作確認
  - _Requirements: 3_

- [ ] 5.1 リセット後の有効化ユニットテストを作成
  - リセット前にゲーム開始状態を作成
  - リセットボタンクリック後にisGameStartedがfalseになることを確認
  - タイマーモードトグルとカウントダウン秒数入力が有効化されることを確認
  - _Requirements: 3_

- [ ] 5.2 リセット機能の統合テストを実施
  - 既存のresetGame関数が正しく状態をリセットすることを確認
  - activePlayerIndexが-1にリセットされることを確認
  - 全プレイヤーの経過時間が0秒にリセットされることを確認
  - ユニットテストが全てパスすることを確認
  - _Requirements: 3_

## Phase 6: E2Eテスト実装

- [ ] 6. タイマーモード変更のE2Eテストを作成する
  - 初期状態でのタイマーモード変更可能性を検証
  - ゲーム開始後のタイマーモード変更禁止を検証
  - 一時停止中のタイマーモード変更禁止を検証
  - リセット後のタイマーモード変更再有効化を検証
  - APIモードでのETag同期を検証
  - _Requirements: 1, 2, 3, 4, 6_

- [ ] 6.1 初期状態とゲーム開始後のE2Eテストを作成
  - ページロード後にタイマーモードトグルが有効であることを確認
  - タイマーモードを変更して正しく反映されることを確認
  - ゲーム開始ボタンをクリック
  - タイマーモードトグルが無効化されることを確認（disabled属性がtrue）
  - カウントダウン秒数入力が無効化されることを確認
  - _Requirements: 1, 2_

- [ ] 6.2 一時停止中とリセット後のE2Eテストを作成
  - ゲーム開始後に一時停止ボタンをクリック
  - タイマーモードトグルが無効化されたままであることを確認
  - リセットボタンをクリック
  - タイマーモードトグルが有効化されることを確認
  - タイマーモードを変更して正しく動作することを確認
  - _Requirements: 2, 3_

- [ ] 6.3 ツールチップとAPIモードのE2Eテストを作成
  - ゲーム開始後にタイマーモードトグルにマウスオーバー
  - ツールチップが表示されることを確認（視覚的検証は手動）
  - APIモードでタイマーモード変更時にupdateGame APIが呼び出されることを確認
  - 新しいETagが取得されることを確認
  - サーバー状態が即座に同期されることを確認
  - _Requirements: 2, 4, 6_

## Phase 7: 実装完了処理

- [ ] 7. 実装完了処理を実施する
  - 全てのユニットテストが成功していることを確認
  - 全てのE2Eテストが成功していることを確認
  - エラーや予期しない動作が発生しないことを確認
  - _Requirements: All_

- [ ] 7.1 最終検証とコミット作成
  - `npm test`で全ユニットテストが成功することを確認
  - `npx playwright test`で全E2Eテストが成功することを確認
  - 既存の他のテストにリグレッションがないことを確認
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _Requirements: All_

## 要件カバレッジ確認

- **Requirement 1** (ゲーム未開始時のタイマーモード変更許可): タスク1, 2, 6
- **Requirement 2** (ゲーム開始後のタイマーモード変更禁止): タスク1, 2, 4, 6
- **Requirement 3** (リセット後の初期状態復帰): タスク2, 5, 6
- **Requirement 4** (タイマーモード変更の基本動作): タスク6（既存機能の維持）
- **Requirement 5** (カウントダウンモード時の秒数設定): タスク3
- **Requirement 6** (ETag管理とAPI同期): タスク6（既存機能の維持）
- **Requirement 7** (フォールバックモードでの動作): 全タスク（両モード対応）
- **Requirement 8** (エラーハンドリング): 既存機能の維持

## 実装の注意事項

### UI制御のポイント
- 既存の`disabled={isGameActive && !isPaused}`を`disabled={isGameStarted}`に変更
- `isGameStarted`の判定式: `activePlayerIndex !== -1 || players.some(p => p.elapsedTimeSeconds > 0)`
- フォールバックモードとAPIモードの両方で同じUI制御ロジックを使用

### テストのポイント
- data-testid属性（timer-mode-toggle）を使用してE2E要素を特定
- フォールバックモードとAPIモードの両方でテストを実施
- 既存のリセット機能が正しく動作することを確認

### コミットのポイント
- 各Phaseごとに細かくコミットを作成
- コミットメッセージには実装内容とテスト結果を含める
- 最終コミットでspec.jsonのphaseを"implementation-done"に更新
