# 技術設計書

## 概要

この機能は、ゲーム進行中（activePlayerIndex !== -1）のAPIモードにおけるUI視認性を改善し、ユーザーがゲーム状態を容易に把握できるようにします。

**ユーザー**: ボードゲームプレイヤーは、ゲーム進行中にアクティブプレイヤー、タイマー、コントロールボタンを明確に識別する必要があります。

**影響**: 既存のPlayerList.tsx、GameTimer.tsx、PlayerList.css、GameTimer.cssのスタイリングを変更し、WCAG 2.1 AAレベルのアクセシビリティ基準を満たすようにします。

### ゴール

- ゲーム進行中のUI要素の視認性を向上させる（コントラスト比4.5:1以上）
- 非アクティブプレイヤーカードの境界を明確にする
- WCAG 2.1 AAレベルのアクセシビリティ基準を遵守する

### 非ゴール

- フォールバックモードのUIスタイリング変更（APIモードのみが対象）
- ゲーム開始前のUIスタイリング変更（ゲーム進行中のみが対象）
- 新しいUI機能の追加（スタイリング改善のみ）

## アーキテクチャ

### 既存アーキテクチャ分析

この機能は既存のコンポーネント構造を変更せず、CSSスタイリングのみを改善します。

**既存コンポーネント**:
- `PlayerList.tsx`: プレイヤーカード一覧表示（16-47行）
- `GameTimer.tsx`: メインタイマーコンポーネント（APIモードセクション）
- `PlayerList.css`: プレイヤーカードのスタイリング（1-84行）
- `GameTimer.css`: ゲームタイマーのスタイリング（1-1169行）

**既存パターン維持**:
- CSS Modulesは使用せず、グローバルCSSクラスを継続使用
- クラス名の命名規則（kebab-case）を維持
- レスポンシブデザインパターン（Mobile First）を継続

### 技術方針との整合性

**技術スタックとの整合**:
- 既存のCSS構成を維持（CSS Modulesへの移行なし）
- React 19.1.1のコンポーネント構造を変更しない
- 既存のレスポンシブデザインパターンを継承

**ステアリング準拠**:
- structure.md: ファイル組織パターンを維持（components/とそのCSSファイル）
- tech.md: 既存のVite + TypeScript + Reactスタックを変更しない
- product.md: アクセシビリティ要件（WCAG 2.1 AA）を遵守

### 重要な設計決定

#### 決定1: CSSのみの変更アプローチ

**決定**: コンポーネントのロジックやJSXを変更せず、CSSスタイリングのみを改善する

**コンテキスト**: UI視認性の問題はコントラスト比とカード境界の不明瞭さが原因であり、UIロジックの問題ではない

**代替案**:
1. JSXを変更してDOMに追加要素を挿入する
2. CSS-in-JSライブラリ（styled-componentsやEmotion）を導入する
3. CSSのみを変更する（選択）

**選択したアプローチ**: CSSのみの変更

**根拠**:
- 既存のコンポーネントロジックは適切に機能している
- CSSの変更のみでWCAG 2.1 AA要件を満たせる
- 技術スタック変更のリスクを回避できる
- テストコードへの影響を最小化できる

**トレードオフ**:
- 獲得: 実装の簡潔さ、リグレッションリスクの最小化、テスト容易性
- 犠牲: CSS-in-JSによる型安全性、動的スタイリングの柔軟性

#### 決定2: WCAG 2.1 AAレベルのコントラスト比基準

**決定**: 全てのテキスト要素に4.5:1以上のコントラスト比を適用する

**コンテキスト**: 現在のスタイルは白背景に薄い色のテキストを使用しており、WCAG基準を満たしていない

**代替案**:
1. WCAG AAA（7:1）を目標とする
2. WCAG AA（4.5:1）を目標とする（選択）
3. カスタム基準（3:1）を設定する

**選択したアプローチ**: WCAG AA（4.5:1）を目標

**根拠**:
- WCAG 2.1 AAは業界標準であり、法的要件を満たす
- AAAは過度に厳しく、デザインの柔軟性を損なう可能性がある
- 現在のカラーパレットを大幅に変更せずに達成可能

**トレードオフ**:
- 獲得: 標準準拠、アクセシビリティ、視認性向上
- 犠牲: デザインの一部色調を調整する必要性

#### 決定3: アクティブプレイヤーカードの強調スタイル

**決定**: アクティブカードに濃い背景色（#1976d2）と白色テキストを適用し、非アクティブカードとの視覚的区別を明確にする

**コンテキスト**: 現在のアクティブカードは淡い緑背景（#f1f8e9）と緑テキスト（#2e7d32）でコントラスト比が不十分

**代替案**:
1. 現在の淡い色スタイルを維持し、テキスト色のみを調整する
2. 濃い背景色と白色テキストに変更する（選択）
3. ボーダーの太さのみを変更する

**選択したアプローチ**: 濃い背景色と白色テキスト

**根拠**:
- 4.5:1以上のコントラスト比を確実に達成できる
- アクティブ状態が一目で識別可能になる
- 既存の視覚的階層（transform: scale）と相乗効果を発揮

**トレードオフ**:
- 獲得: 明確な視覚的区別、WCAG準拠、ユーザビリティ向上
- 犠牲: 既存のカラーパレット変更、デザイン全体の調整が必要

## コンポーネントとインターフェース

### UIスタイリング層

#### PlayerList.css

**責務と境界**
- **主要責務**: プレイヤーカードの視覚的スタイリング
- **ドメイン境界**: プレゼンテーション層（CSSのみ）
- **データ所有権**: なし（状態はPlayerList.tsxが管理）

**依存関係**
- **インバウンド**: PlayerList.tsx（CSSクラスを適用）
- **アウトバウンド**: なし
- **外部**: なし

**スタイリング契約**

変更対象のCSSクラス:

1. `.player-card` (10-20行)
   - 変更前: `border: 2px solid #e0e0e0; background-color: #ffffff;`
   - 変更後: `border: 3px solid #9e9e9e; background-color: #ffffff;`
   - 理由: カード境界を明確化（2px → 3px、#e0e0e0 → #9e9e9e）

2. `.player-card.active` (22-27行)
   - 変更前: `border-color: #4caf50; background-color: #f1f8e9;`
   - 変更後: `border-color: #1976d2; background-color: #1976d2;`
   - 理由: アクティブカードの強調（青系背景で白テキストのコントラスト確保）

3. `.player-name` (39-43行)
   - 変更前: `color: #333;`
   - 変更後: `color: #212121;`（非アクティブ時）
   - 追加: `.player-card.active .player-name { color: #ffffff; }`（アクティブ時）

4. `.player-timer` (45-50行)
   - 変更前: `color: #555;`
   - 変更後: `color: #212121;`（非アクティブ時）
   - 追加: `.player-card.active .player-timer { color: #ffffff; }`（アクティブ時）

**事前条件**:
- PlayerList.tsxが正しくCSSクラスを適用していること
- ブラウザがCSS3をサポートしていること

**事後条件**:
- 全てのテキスト要素が4.5:1以上のコントラスト比を持つこと
- 非アクティブカードの境界が明確に識別可能であること

**不変条件**:
- レスポンシブデザインパターンが維持されること
- クラス名の命名規則が維持されること

#### GameTimer.css（APIモードセクション）

**責務と境界**
- **主要責務**: ゲームタイマーUI要素の視覚的スタイリング
- **ドメイン境界**: プレゼンテーション層（CSSのみ）
- **データ所有権**: なし（状態はGameTimer.tsxが管理）

**依存関係**
- **インバウンド**: GameTimer.tsx（CSSクラスを適用）
- **アウトバウンド**: なし
- **外部**: なし

**スタイリング契約**

変更対象のCSSクラス:

1. `.sticky-header-player` (158-162行)
   - 変更前: `color: #1976d2;`
   - 変更後: `color: #0d47a1;`
   - 理由: 白背景に対するコントラスト比向上

2. `.sticky-header-time` (164-171行)
   - 変更前: `color: #2e7d32; background: rgba(46, 125, 50, 0.1);`
   - 変更後: `color: #1b5e20; background: rgba(27, 94, 32, 0.15);`
   - 理由: コントラスト比4.5:1以上を確保

3. `.next-player-btn` (209-217行、746-766行)
   - 変更前: `background: #2e7d32;`
   - 変更後: `background: #1b5e20;`
   - 理由: ボタンテキスト（白）とのコントラスト比向上

4. `.pause-btn` (198-206行)
   - 変更前: `background: #ff9800;`
   - 変更後: `background: #ef6c00;`
   - 理由: ボタンテキスト（白）とのコントラスト比向上

**事前条件**:
- GameTimer.tsxが正しくCSSクラスを適用していること
- APIモード（isInFallbackMode === false）でのみ適用されること

**事後条件**:
- 全てのボタンラベルが4.5:1以上のコントラスト比を持つこと
- タイマー数値が明確に識別可能であること

**統合戦略**:
- **変更アプローチ**: 既存CSSクラスの色値のみを変更
- **後方互換性**: CSSクラス名は変更しないため、既存の参照を維持
- **移行パス**: 段階的デプロイ不要（CSSの変更は即座に適用）

## データモデル

この機能はデータモデルを変更しません。既存のGameState、Player型定義をそのまま使用します。

## エラーハンドリング

### エラー戦略

この機能はCSSのみの変更であり、実行時エラーは発生しません。ただし、以下の検証エラーが考えられます。

**検証エラー**:
- コントラスト比検証失敗: 自動テストでコントラスト比が4.5:1未満の要素が検出された場合

**対応**:
- テスト失敗時にCSSカラー値を調整
- WCAG基準を満たすまで反復的に修正

## テスト戦略

### ユニットテスト

CSSのみの変更のため、ユニットテストは不要です。

### 統合テスト

**コントラスト比検証テスト** (`frontend/src/hooks/__tests__/contrastRatio.test.ts`):
- WCAG 2.1 AAレベルのコントラスト比検証
- アクティブプレイヤー名のコントラスト比検証（#1976d2背景 + #ffffff前景 = 4.5:1以上）
- 非アクティブプレイヤー名のコントラスト比検証（#ffffff背景 + #212121前景 = 12.63:1）
- タイマー数値のコントラスト比検証
- ボタンラベルのコントラスト比検証

### E2Eテスト

**視覚的回帰テスト** (`e2e/specs/ui-visibility.spec.ts`):
- ゲーム進行中の全UI要素のスクリーンショット撮影
- アクティブプレイヤーカードの視覚的確認
- 非アクティブプレイヤーカードの境界確認
- タイマー表示の視認性確認
- コントロールボタンの視認性確認

**アクセシビリティテスト** (`e2e/specs/accessibility.spec.ts`):
- Playwright AccessibilityツールでのWCAG検証
- コントラスト比自動検証
- キーボードナビゲーション検証

### パフォーマンステスト

**レンダリングパフォーマンス**:
- CSS変更前後のフレームレート測定（60fps維持確認）
- Chrome DevToolsパフォーマンスプロファイラで検証

## セキュリティ考慮事項

この機能はCSSのみの変更であり、セキュリティ上の懸念はありません。

## パフォーマンスとスケーラビリティ

### 目標メトリクス

- **フレームレート**: 60fps以上を維持（CSS変更前後で差異なし）
- **初回レンダリング**: CSSパース時間の増加は1ms未満

### 最適化手法

**CSSの最適化**:
- 不要なCSSセレクタを削除しない（既存スタイルを維持）
- CSS変更は特定度を変更せず、プロパティ値のみを変更

**測定戦略**:
- Chrome DevTools Performanceタブで初回レンダリング時間を測定
- Lighthouseスコアでアクセシビリティスコアを検証

