# 実装計画

## 完了済みタスク（証跡保持）

以下のタスクは既に実装完了しています。段階的実装戦略への移行に伴い、一部のコードは削除されますが、実装履歴として記録を保持します。

- [x] 1. プロジェクト基盤とインフラストラクチャのセットアップ
  - フロントエンドプロジェクトをReact 18 + TypeScript + Viteで初期化
  - Azure Functions APIプロジェクトをNode.js 20 + TypeScriptで作成
  - Azure Cosmos DB (Table API) のテーブル構造を定義・作成
  - Azure SignalR Serviceの接続設定と環境変数の構成
  - Azure Static Web Appsのデプロイ設定(GitHub Actions CI/CD統合)
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 2. コアデータモデルと型定義の実装
  - GameStateインターフェース(プレイヤー配列、アクティブID、一時停止状態、タイマーモード)の定義
  - Playerインターフェース(ID、名前、経過時間、初期時間、アクティブ状態)の定義
  - タイマーモード('count-up' | 'count-down')の型定義とデフォルト値設定
  - SignalRハブメソッドスキーマ(TurnSwitched, TimerUpdated, GameReset, PlayersUpdated)の定義
  - ビジネスルール検証関数(プレイヤー数4-6、経過時間非負、アクティブプレイヤー最大1人)の実装
  - _要件: 1.1, 1.2, 2.2_

- [x] 3. データ永続化レイヤーの構築
- [x] 3.1 Cosmos DB Repository実装
  - @azure/data-tablesパッケージのインストールと接続設定
  - GameStateEntityのCRUD操作(作成、読み取り、更新、削除)を実装
  - PartitionKey "game" + RowKey "current"の単一エンティティ管理ロジック
  - ETagによる楽観的ロック処理と競合解決
  - _要件: 7.4_

- [x] 3.2 データ永続化の統合テスト
  - モック環境でのCRUD操作テスト
  - 楽観的ロック競合シナリオのテスト
  - 接続エラー時のリトライロジックテスト
  - _要件: 7.4_

- [x] 4. SignalRリアルタイム通信の実装
- [x] 4.1 SignalRサーバーサイド設定
  - Azure Functions SignalR Output Bindingの設定
  - SignalRハブ 'gameHub' の作成
  - イベント送信関数(TurnSwitched, TimerUpdated, GameReset, PlayersUpdated)の実装
  - _要件: 5.2, 7.3_

- [x] 4.2 SignalRクライアント接続管理
  - @microsoft/signalrパッケージのインストール
  - HubConnectionBuilderによる接続初期化(自動再接続設定)
  - サーバーイベントリスナーの登録(on('TurnSwitched'), on('TimerUpdated')等)
  - 接続状態管理(接続中/切断中/再接続中)のUIインジケーター
  - _要件: 5.1, 5.2_

- [x] 5. Azure Functions APIエンドポイントの実装
- [x] 5.1 ゲーム状態取得API
  - GET /api/gameエンドポイント実装
  - Cosmos DBから現在のゲーム状態を取得
  - 初回アクセス時のデフォルト状態(4人プレイヤー、カウントアップモード)初期化
  - _要件: 1.1, 1.4_

- [x] 5.2 ターン切り替えAPI
  - POST /api/switchTurnエンドポイント実装
  - 現在プレイヤーのタイマー停止、次プレイヤーのタイマー開始ロジック
  - 最後のプレイヤーから最初のプレイヤーへの循環処理
  - ビジネスルール検証(プレイヤーID有効性、アクティブプレイヤー排他制御)
  - SignalR TurnSwitchedイベントの送信
  - _要件: 3.3, 3.4_

- [x] 5.3 タイマー同期API
  - POST /api/syncTimerエンドポイント実装
  - クライアントから送信された経過時間の検証と保存
  - カウントアップ/カウントダウンモード別のタイマー値更新ロジック
  - カウントダウンモードでの時間切れ検出(0:00到達)
  - SignalR TimerUpdatedイベントの送信
  - _要件: 2.2, 2.3, 2.5, 2.7_

- [x] 5.4 ゲームコントロールAPI
  - POST /api/resetGameエンドポイント実装(全タイマーリセット)
  - POST /api/pauseGameエンドポイント実装(アクティブタイマー一時停止)
  - POST /api/resumeGameエンドポイント実装(一時停止解除)
  - POST /api/updatePlayersエンドポイント実装(プレイヤー数4-6で変更)
  - SignalR GameReset/PlayersUpdatedイベントの送信
  - _要件: 1.2, 2.6, 2.8, 4.1, 4.2, 4.3_

- [x] 5.5 タイマーモード切り替えAPI
  - POST /api/setTimerModeエンドポイント実装
  - カウントアップ/カウントダウンモードの切り替え処理
  - カウントダウンモード時の初期時間設定(デフォルト600秒)
  - タイマーモード変更時の全プレイヤーの時間初期化
  - _要件: 2.2, 2.4_

- [x] 6. フロントエンドReactコンポーネントの実装
- [x] 6.1 GameTimerルートコンポーネント
  - GameTimerStateの状態管理(useState, useEffectによる初期化)
  - SignalR接続のライフサイクル管理(接続、切断、再接続)
  - サーバーイベントハンドラの登録と状態更新ロジック
  - 楽観的更新(クライアント側即時反映)の実装
  - _要件: 5.1, 5.2, 5.4_

- [x] 6.2 PlayerListコンポーネント
  - プレイヤー一覧の表示(プレイヤー名、タイマー値)
  - アクティブプレイヤーのビジュアルハイライト(CSSクラス切り替え)
  - タイマー値のMM:SS形式フォーマット関数
  - カウントダウンモードでの時間切れ視覚通知(赤色表示等)
  - _要件: 1.4, 2.1, 2.7, 3.2_

- [x] 6.3 TimerControlsコンポーネント
  - ターン切り替えボタン(次のプレイヤーへ)の実装
  - 一時停止/再開ボタンの実装
  - リセットボタンの実装
  - プレイヤー数変更UI(4-6人の範囲選択)
  - タイマーモード切り替えボタン(カウントアップ/ダウン)
  - カウントダウンモード時の初期時間設定入力フィールド
  - _要件: 1.2, 2.2, 3.3, 4.1, 4.2, 4.3, 4.4_

- [x] 6.4 クライアントサイドタイマーロジック
  - 1秒ごとのタイマー更新(setInterval)
  - カウントアップモード: 経過時間+1秒
  - カウントダウンモード: 残り時間-1秒
  - 5秒ごとのサーバー同期(POST /api/syncTimer)
  - カウントダウンモードでの0:00到達時の停止処理
  - _要件: 2.3, 2.4, 2.5, 2.7_

- [x] 7. 最低限のエラーハンドリング（デプロイ前の必須対応）
  - Zodスキーマバリデーション(プレイヤー数、プレイヤーID、タイマー値)
  - 400エラー: 無効な入力時のエラーレスポンス
  - 422エラー: ビジネスルール違反時のエラーレスポンス
  - 500エラー: 基本的なエラーレスポンス
  - _要件: すべての要件の基本エラー処理_

- [x] 8. Azure環境へのデプロイ
- [x] 8.1 Azureリソースのプロビジョニング
  - Azureリソースプロビジョニング手順書を作成(`docs/AZURE_DEPLOYMENT.md`)
  - Azure Cosmos DB Free Tierアカウント作成手順を記載(Table API)
  - Azure SignalR Service Free Tierインスタンス作成手順を記載
  - Azure Static Web Appsリソース作成手順を記載(Managed Functionsを含む)
  - _要件: 7.1, 7.3, 7.4_

- [x] 8.2 環境変数とシークレット設定
  - 環境変数設定手順書を作成(`docs/ENVIRONMENT_SETUP.md`)
  - ローカル開発環境設定(`api/local.settings.json`)の手順を記載
  - GitHub Secretsへのシークレット登録手順を記載(CI/CD用)
  - Azure Static Web Appsアプリケーション設定手順を記載
  - _要件: 7.1, 7.3, 7.4_

- [x] 8.3 CI/CDパイプラインの構築
  - デプロイメント検証手順書を作成(`docs/DEPLOYMENT_VERIFICATION.md`)
  - GitHub Actionsワークフロー動作確認手順を記載
  - デプロイ後の動作確認テスト手順を記載
  - トラブルシューティングガイドを記載
  - _要件: 7.1, 7.2_

---

## Phase 1: インメモリータイマー実装（段階的実装開始）

**目標**: React `useState`のみを使用した基本タイマー機能の実装と動作検証。DB/SignalR接続を排除し、タイマーロジックとUI/UXを確立。

### Phase 1 準備タスク

- [x] 9. Phase 1への移行準備とクリーンアップ
- [x] 9.1 不要なバックエンドコードの削除
  - `api/` ディレクトリ全体を削除（Azure Functions、Cosmos DB、SignalR サーバー側コード）
  - Azure関連パッケージのアンインストール（`@azure/data-tables`, `@azure/functions`, `@microsoft/signalr`サーバー側）
  - _要件: なし（技術的準備）_

- [x] 9.2 フロントエンドの依存関係クリーンアップ
  - `@microsoft/signalr` パッケージのアンインストール
  - SignalR関連のクライアントコード削除（接続管理、イベントリスナー）
  - 環境変数からAzure接続文字列削除
  - _要件: なし（技術的準備）_

### Phase 1 コア実装

- [ ] 10. インメモリー状態管理の実装
- [x] 10.1 GameStateのuseState実装
  - プレイヤー配列、アクティブプレイヤーID、タイマーモード、一時停止状態を`useState`で管理
  - デフォルト状態（4人プレイヤー、カウントアップモード）の初期化
  - プレイヤー数変更機能（4〜6人）の実装
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.2_

- [x] 10.2 タイマーロジックの実装
  - `setInterval`による1秒ごとのタイマー更新
  - カウントアップモード: 経過時間+1秒
  - カウントダウンモード: 残り時間-1秒、0:00で停止
  - アクティブプレイヤーのみタイマー動作（排他制御）
  - _要件: 2.3, 2.4, 2.5, 2.7_

- [x] 10.3 ターン管理機能の実装
  - ターン切り替えボタン: 現在プレイヤー停止 → 次プレイヤー開始
  - 最後のプレイヤーから最初のプレイヤーへの循環処理
  - アクティブプレイヤーの視覚的ハイライト表示
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 10.4 ゲームコントロール機能の実装
  - リセットボタン: 全プレイヤーのタイマーを初期値にリセット
  - 一時停止/再開ボタン: アクティブタイマーの一時停止と再開
  - タイマーモード切り替え（カウントアップ/カウントダウン）
  - カウントダウンモード時の初期時間設定UI
  - _要件: 2.2, 2.4, 2.6, 2.8, 4.1, 4.2, 4.3, 4.4_

### Phase 1 UI/UX実装

- [ ] 11. レスポンシブデザインの実装
  - CSS GridとMedia Queriesによるレイアウト定義
  - スマートフォン(375px以下): 縦スクロール可能な単列レイアウト
  - タブレット(768px以上): 2列グリッドレイアウト
  - PC(1024px以上): 3-4列グリッドレイアウト
  - ボタンとタイマー表示の読みやすいフォントサイズ設定
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 12. UI改善とユーザビリティ向上
  - タイマー値のMM:SS形式フォーマット表示
  - カウントダウンモードでの時間切れ視覚通知（赤色表示、アニメーション）
  - 無効な操作の防止（他プレイヤーのターン中のボタン無効化）
  - プレイヤー数変更時の入力バリデーション（4〜6人範囲チェック）
  - _要件: 1.2, 2.1, 2.7_

### Phase 1 テストとデプロイ

- [ ] 13. Phase 1ユニットテストの実装
- [ ] 13.1 タイマーロジックのテスト
  - カウントアップモードのタイマー動作テスト
  - カウントダウンモードのタイマー動作テスト（0:00到達含む）
  - 一時停止/再開機能のテスト
  - リセット機能のテスト
  - _要件: 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [ ] 13.2 ターン管理ロジックのテスト
  - ターン切り替え機能のテスト（循環処理含む）
  - アクティブプレイヤー排他制御のテスト
  - プレイヤー数変更時の状態更新テスト
  - _要件: 1.2, 3.1, 3.2, 3.3, 3.4_

- [ ] 13.3 UIコンポーネントのテスト
  - PlayerListコンポーネントのレンダリングテスト
  - TimerControlsコンポーネントのボタン動作テスト
  - レスポンシブレイアウトの表示テスト
  - _要件: 1.4, 2.1, 6.1, 6.2, 6.3, 6.4_

- [ ] 14. Phase 1 デプロイと動作確認
- [ ] 14.1 ローカル環境での動作検証
  - ブラウザでの基本操作フロー確認（タイマー開始→停止→ターン切り替え→リセット）
  - レスポンシブデザインの表示確認（モバイル、タブレット、PC）
  - タイマーモード切り替え動作確認
  - _要件: 全Phase 1要件_

- [ ] 14.2 Phase 1本番デプロイ
  - Azure Static Web Appsへのフロントエンドのみデプロイ
  - パブリックURLからのアクセステスト
  - 複数デバイスからの動作確認（同期なし、各デバイス独立動作）
  - _要件: 7.1, 7.2_

---

## Phase 2: Cosmos DB統合（データ永続化）

**目標**: Cosmos DBによる状態永続化を追加。複数デバイス間でのゲーム状態共有を実現（リアルタイム同期なし、手動リロードで同期）。

### Phase 2 準備タスク

- [ ] 15. Phase 2への移行準備
- [ ] 15.1 Azure Functions APIプロジェクトの再構築
  - `api/` ディレクトリの再作成（Node.js 20 + TypeScript）
  - Azure Functions SDK (`@azure/functions`) のインストール
  - TypeScript設定とビルド環境の構築
  - _要件: 7.1_

- [ ] 15.2 Cosmos DB接続の再構築
  - `@azure/data-tables` パッケージのインストール
  - Cosmos DB接続設定と環境変数の構成
  - GameStateEntityのCRUD操作実装
  - _要件: 7.4_

### Phase 2 コア実装

- [ ] 16. Azure Functions APIエンドポイントの実装
- [ ] 16.1 ゲーム状態取得・保存API
  - GET /api/game: Cosmos DBから現在のゲーム状態を取得
  - POST /api/updateGame: ゲーム状態をCosmos DBに保存
  - 初回アクセス時のデフォルト状態初期化
  - _要件: 1.1, 1.4, 5.1_

- [ ] 16.2 ターン切り替えAPI
  - POST /api/switchTurn: ターン切り替えロジック + Cosmos DB更新
  - ビジネスルール検証（プレイヤーID有効性、排他制御）
  - _要件: 3.3, 3.4_

- [ ] 16.3 ゲームコントロールAPI
  - POST /api/resetGame: リセット + Cosmos DB更新
  - POST /api/pauseGame: 一時停止 + Cosmos DB更新
  - POST /api/resumeGame: 再開 + Cosmos DB更新
  - POST /api/updatePlayers: プレイヤー数変更 + Cosmos DB更新
  - POST /api/setTimerMode: タイマーモード切り替え + Cosmos DB更新
  - _要件: 1.2, 2.2, 2.4, 2.6, 2.8, 4.1, 4.2, 4.3, 4.4_

- [ ] 16.4 タイマー同期API
  - POST /api/syncTimer: クライアント側タイマー値をサーバーに同期
  - カウントアップ/カウントダウンモード別の更新ロジック
  - カウントダウンモードでの時間切れ検出
  - _要件: 2.2, 2.3, 2.5, 2.7_

### Phase 2 フロントエンド統合

- [ ] 17. フロントエンドのAPI統合
- [ ] 17.1 状態管理のAPI連携実装
  - `useEffect`でのゲーム状態初期化（GET /api/game）
  - タイマー操作時のAPI呼び出し（POST /api/switchTurn等）
  - 楽観的更新の実装（クライアント側即時反映 + サーバー確認）
  - _要件: 5.1, 5.4_

- [ ] 17.2 定期的なサーバー同期
  - 5秒ごとのタイマー値同期（POST /api/syncTimer）
  - 他デバイスの更新を取得するための定期的なポーリング（GET /api/game）
  - 競合解決ロジック（サーバー側の値を優先）
  - _要件: 5.1, 5.2_

### Phase 2 テストとデプロイ

- [ ] 18. Phase 2テストの実装
- [ ] 18.1 バックエンドユニットテスト
  - APIエンドポイントのビジネスルール検証テスト
  - Cosmos DB CRUD操作のモックテスト
  - バリデーションエラーハンドリングのテスト
  - _要件: 全Phase 2 API要件_

- [ ] 18.2 API統合テスト
  - POST /api/switchTurn → Cosmos DB更新フロー
  - POST /api/resetGame → タイマー初期化フロー
  - 複数クライアントからの同時更新テスト
  - _要件: 5.1, 5.2_

- [ ] 19. Phase 2 デプロイと動作確認
- [ ] 19.1 Azure環境へのデプロイ
  - Azure Static Web Apps + Managed Functionsへのデプロイ
  - Cosmos DB接続の動作確認
  - 環境変数とシークレットの設定確認
  - _要件: 7.1, 7.2, 7.4_

- [ ] 19.2 Phase 2本番環境動作確認
  - パブリックURLからのアクセステスト
  - 複数デバイスからの同時アクセステスト（手動リロードで同期確認）
  - Cosmos DB読み書き性能確認（<10ms読み取り、<15ms書き込み）
  - _要件: 5.1, 7.2, 7.4_

---

## Phase 3: SignalR統合（リアルタイム同期）

**目標**: Azure SignalR Serviceによるリアルタイム多デバイス同期を追加。複数デバイス間で1秒以内に状態を自動同期。

### Phase 3 準備タスク

- [ ] 20. Phase 3への移行準備
- [ ] 20.1 SignalRサーバーサイド設定
  - Azure Functions SignalR Output Bindingの設定
  - SignalRハブ 'gameHub' の作成
  - 環境変数へのSignalR接続文字列追加
  - _要件: 5.2, 7.3_

- [ ] 20.2 SignalRクライアント依存関係の追加
  - `@microsoft/signalr` パッケージのインストール
  - SignalR接続設定の準備
  - _要件: 5.1_

### Phase 3 コア実装

- [ ] 21. SignalRイベント送信の実装
- [ ] 21.1 サーバー側イベント送信
  - TurnSwitchedイベント送信（ターン切り替え時）
  - TimerUpdatedイベント送信（タイマー同期時）
  - GameResetイベント送信（リセット時）
  - PlayersUpdatedイベント送信（プレイヤー数変更時）
  - _要件: 5.2_

- [ ] 21.2 SignalR Negotiateエンドポイント
  - GET /api/negotiate: SignalR接続ネゴシエーション
  - クライアント接続トークンの発行
  - _要件: 5.1_

### Phase 3 フロントエンド統合

- [ ] 22. SignalRクライアント接続の実装
- [ ] 22.1 SignalR接続管理
  - HubConnectionBuilderによる接続初期化
  - 自動再接続設定（withAutomaticReconnect）
  - 接続状態管理（接続中/切断中/再接続中）のUIインジケーター
  - _要件: 5.1, 5.2_

- [ ] 22.2 SignalRイベントリスナーの実装
  - on('TurnSwitched'): ターン切り替えイベント受信 → 状態更新
  - on('TimerUpdated'): タイマー更新イベント受信 → 状態更新
  - on('GameReset'): リセットイベント受信 → 状態初期化
  - on('PlayersUpdated'): プレイヤー数変更イベント受信 → 状態更新
  - _要件: 5.2_

- [ ] 22.3 SignalR接続エラー対応
  - 接続失敗時の自動再接続処理
  - 再接続中のUI表示（ローディングスピナー等）
  - 再接続成功後の状態同期（GET /api/gameで最新状態取得）
  - _要件: 5.2_

### Phase 3 テストとデプロイ

- [ ] 23. Phase 3テストの実装
- [ ] 23.1 SignalRイベント送信テスト
  - SignalRイベント送信のモックテスト
  - API呼び出し → イベント送信フローのテスト
  - _要件: 5.2_

- [ ] 23.2 SignalRクライアント統合テスト
  - SignalR接続 → イベント受信 → 状態同期フロー
  - 複数クライアントへのブロードキャスト確認
  - 接続エラー時の再接続処理テスト
  - _要件: 5.1, 5.2_

- [ ] 23.3 E2Eテスト（Playwright）
  - 基本操作フロー: アプリ起動→ターン開始→タイマー動作→ターン切り替え
  - 複数デバイス同期: 2つのブラウザタブで同時アクセス→片方で操作→もう片方でリアルタイム反映
  - リセット機能: ゲーム進行中→リセット→全タイマー0:00確認
  - _要件: すべての要件の統合動作確認_

- [ ] 24. Phase 3 最終デプロイと動作確認
- [ ] 24.1 Azure環境への完全デプロイ
  - Azure SignalR Serviceの有効化
  - フロントエンド + バックエンド + SignalRの統合デプロイ
  - 環境変数とシークレットの最終確認
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ] 24.2 Phase 3本番環境動作確認
  - パブリックURLからのアクセステスト
  - 複数デバイスからの同時アクセステスト（リアルタイム同期確認）
  - SignalRリアルタイム同期の遅延測定（<1秒確認）
  - 全機能の統合動作確認
  - _要件: 全要件の最終確認_

---

## 全フェーズ共通: 最終仕上げタスク

- [ ] 25. 詳細なエラーハンドリングと回復性の強化
- [ ] 25.1 フロントエンドバリデーション
  - プレイヤー数入力の範囲チェック(4-6)とエラーメッセージ表示
  - 無効な操作(他プレイヤーのターン中の開始)のUI無効化
  - API呼び出しエラー時のユーザー通知(トースト表示等)
  - _要件: 1.2_

- [ ] 25.2 バックエンド高度なエラーハンドリング
  - 500エラー: Cosmos DB接続失敗時のリトライロジック(3回、指数バックオフ)
  - 503エラー: SignalRメッセージ数上限到達時のエラーレスポンス
  - _要件: すべての要件の高度なエラー処理_

- [ ] 26. パフォーマンス最適化
  - Code Splitting(React.lazy)によるバンドルサイズ削減
  - React.memoによる不要な再レンダリング防止
  - SignalRへのバッチ送信(複数イベント集約)
  - Cosmos DBクエリの最適化(PartitionKey + RowKey直接指定)
  - CDNキャッシュ設定(静的アセット max-age=31536000)
  - _要件: すべての要件のパフォーマンス向上_

- [ ] 27. セキュリティ対策
  - Rate Limiting設定(Azure Functions: 100リクエスト/分/IP)
  - HTTPS強制(Azure Static Web Apps標準)
  - SignalR接続のTLS 1.2以上強制
  - 入力バリデーション(Zodスキーマ)の全APIエンドポイント適用
  - _要件: すべての要件のセキュリティ確保_

- [ ] 28. モニタリングとロギング
  - Azure Application Insights統合(Free Tier 5GB/月)
  - API呼び出しログ記録(INFO レベル)
  - エラーログ記録(ERROR レベル: 500系、WARN レベル: 422)
  - SignalR接続状態の定期監視(60秒ごと)
  - ヘルスチェックエンドポイント(Azure Functions標準)の設定
  - _要件: すべての要件の運用監視_
