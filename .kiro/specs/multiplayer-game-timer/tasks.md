# 実装計画

- [x] 1. プロジェクト基盤とインフラストラクチャのセットアップ
  - フロントエンドプロジェクトをReact 18 + TypeScript + Viteで初期化
  - Azure Functions APIプロジェクトをNode.js 20 + TypeScriptで作成
  - Azure Cosmos DB (Table API) のテーブル構造を定義・作成
  - Azure SignalR Serviceの接続設定と環境変数の構成
  - Azure Static Web Appsのデプロイ設定(GitHub Actions CI/CD統合)
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 2. コアデータモデルと型定義の実装
  - GameStateインターフェース(プレイヤー配列、アクティブID、一時停止状態、タイマーモード)の定義
  - Playerインターフェース(ID、名前、経過時間、初期時間、アクティブ状態)の定義
  - タイマーモード('count-up' | 'count-down')の型定義とデフォルト値設定
  - SignalRハブメソッドスキーマ(TurnSwitched, TimerUpdated, GameReset, PlayersUpdated)の定義
  - ビジネスルール検証関数(プレイヤー数4-6、経過時間非負、アクティブプレイヤー最大1人)の実装
  - _要件: 1.1, 1.2, 2.2_

- [x] 3. データ永続化レイヤーの構築
- [x] 3.1 Cosmos DB Repository実装
  - @azure/data-tablesパッケージのインストールと接続設定
  - GameStateEntityのCRUD操作(作成、読み取り、更新、削除)を実装
  - PartitionKey "game" + RowKey "current"の単一エンティティ管理ロジック
  - ETagによる楽観的ロック処理と競合解決
  - _要件: 7.4_

- [x] 3.2 データ永続化の統合テスト
  - モック環境でのCRUD操作テスト
  - 楽観的ロック競合シナリオのテスト
  - 接続エラー時のリトライロジックテスト
  - _要件: 7.4_

- [x] 4. SignalRリアルタイム通信の実装
- [x] 4.1 SignalRサーバーサイド設定
  - Azure Functions SignalR Output Bindingの設定
  - SignalRハブ 'gameHub' の作成
  - イベント送信関数(TurnSwitched, TimerUpdated, GameReset, PlayersUpdated)の実装
  - _要件: 5.2, 7.3_

- [x] 4.2 SignalRクライアント接続管理
  - @microsoft/signalrパッケージのインストール
  - HubConnectionBuilderによる接続初期化(自動再接続設定)
  - サーバーイベントリスナーの登録(on('TurnSwitched'), on('TimerUpdated')等)
  - 接続状態管理(接続中/切断中/再接続中)のUIインジケーター
  - _要件: 5.1, 5.2_

- [x] 5. Azure Functions APIエンドポイントの実装
- [x] 5.1 ゲーム状態取得API
  - GET /api/gameエンドポイント実装
  - Cosmos DBから現在のゲーム状態を取得
  - 初回アクセス時のデフォルト状態(4人プレイヤー、カウントアップモード)初期化
  - _要件: 1.1, 1.4_

- [x] 5.2 ターン切り替えAPI
  - POST /api/switchTurnエンドポイント実装
  - 現在プレイヤーのタイマー停止、次プレイヤーのタイマー開始ロジック
  - 最後のプレイヤーから最初のプレイヤーへの循環処理
  - ビジネスルール検証(プレイヤーID有効性、アクティブプレイヤー排他制御)
  - SignalR TurnSwitchedイベントの送信
  - _要件: 3.3, 3.4_

- [x] 5.3 タイマー同期API
  - POST /api/syncTimerエンドポイント実装
  - クライアントから送信された経過時間の検証と保存
  - カウントアップ/カウントダウンモード別のタイマー値更新ロジック
  - カウントダウンモードでの時間切れ検出(0:00到達)
  - SignalR TimerUpdatedイベントの送信
  - _要件: 2.2, 2.3, 2.5, 2.7_

- [x] 5.4 ゲームコントロールAPI
  - POST /api/resetGameエンドポイント実装(全タイマーリセット)
  - POST /api/pauseGameエンドポイント実装(アクティブタイマー一時停止)
  - POST /api/resumeGameエンドポイント実装(一時停止解除)
  - POST /api/updatePlayersエンドポイント実装(プレイヤー数4-6で変更)
  - SignalR GameReset/PlayersUpdatedイベントの送信
  - _要件: 1.2, 2.6, 2.8, 4.1, 4.2, 4.3_

- [x] 5.5 タイマーモード切り替えAPI
  - POST /api/setTimerModeエンドポイント実装
  - カウントアップ/カウントダウンモードの切り替え処理
  - カウントダウンモード時の初期時間設定(デフォルト600秒)
  - タイマーモード変更時の全プレイヤーの時間初期化
  - _要件: 2.2, 2.4_

- [x] 6. フロントエンドReactコンポーネントの実装
- [x] 6.1 GameTimerルートコンポーネント
  - GameTimerStateの状態管理(useState, useEffectによる初期化)
  - SignalR接続のライフサイクル管理(接続、切断、再接続)
  - サーバーイベントハンドラの登録と状態更新ロジック
  - 楽観的更新(クライアント側即時反映)の実装
  - _要件: 5.1, 5.2, 5.4_

- [x] 6.2 PlayerListコンポーネント
  - プレイヤー一覧の表示(プレイヤー名、タイマー値)
  - アクティブプレイヤーのビジュアルハイライト(CSSクラス切り替え)
  - タイマー値のMM:SS形式フォーマット関数
  - カウントダウンモードでの時間切れ視覚通知(赤色表示等)
  - _要件: 1.4, 2.1, 2.7, 3.2_

- [x] 6.3 TimerControlsコンポーネント
  - ターン切り替えボタン(次のプレイヤーへ)の実装
  - 一時停止/再開ボタンの実装
  - リセットボタンの実装
  - プレイヤー数変更UI(4-6人の範囲選択)
  - タイマーモード切り替えボタン(カウントアップ/ダウン)
  - カウントダウンモード時の初期時間設定入力フィールド
  - _要件: 1.2, 2.2, 3.3, 4.1, 4.2, 4.3, 4.4_

- [x] 6.4 クライアントサイドタイマーロジック
  - 1秒ごとのタイマー更新(setInterval)
  - カウントアップモード: 経過時間+1秒
  - カウントダウンモード: 残り時間-1秒
  - 5秒ごとのサーバー同期(POST /api/syncTimer)
  - カウントダウンモードでの0:00到達時の停止処理
  - _要件: 2.3, 2.4, 2.5, 2.7_

- [ ] 7. 最低限のエラーハンドリング（デプロイ前の必須対応）
  - Zodスキーマバリデーション(プレイヤー数、プレイヤーID、タイマー値)
  - 400エラー: 無効な入力時のエラーレスポンス
  - 422エラー: ビジネスルール違反時のエラーレスポンス
  - 500エラー: 基本的なエラーレスポンス
  - _要件: すべての要件の基本エラー処理_

- [ ] 8. Azure環境へのデプロイ
- [ ] 8.1 Azureリソースのプロビジョニング
  - Azure Cosmos DB Free Tierアカウント作成(Table API)
  - Azure SignalR Service Free Tierインスタンス作成
  - Azure Static Web Appsリソース作成
  - Azure Functionsリソース作成(Consumption Plan)
  - _要件: 7.1, 7.3, 7.4_

- [ ] 8.2 環境変数とシークレット設定
  - Cosmos DB接続文字列の環境変数設定
  - SignalR Service接続文字列の環境変数設定
  - GitHub Secretsへのシークレット登録(CI/CD用)
  - _要件: 7.1, 7.3, 7.4_

- [ ] 8.3 CI/CDパイプラインの構築
  - GitHub Actionsワークフロー作成(フロントエンドビルド→Static Web Appsデプロイ)
  - GitHub Actionsワークフロー作成(バックエンドビルド→Azure Functionsデプロイ)
  - デプロイ後の動作確認テスト自動実行
  - _要件: 7.1, 7.2_

- [ ] 9. 本番環境動作確認
  - パブリックURLからのアクセステスト
  - 複数デバイスからの同時アクセステスト
  - SignalRリアルタイム同期の遅延測定(<1秒確認)
  - Cosmos DB読み書き性能確認(<10ms読み取り、<15ms書き込み)
  - _要件: 7.2, 5.1, 5.2_

- [ ] 10. レスポンシブデザインの実装
  - CSS GridとMedia Queriesによるレイアウト定義
  - スマートフォン(375px以下): 縦スクロール可能な単列レイアウト
  - タブレット(768px以上): 2列グリッドレイアウト
  - PC(1024px以上): 3-4列グリッドレイアウト
  - ボタンとタイマー表示の読みやすいフォントサイズ設定
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 11. 詳細なエラーハンドリングと回復性の強化
- [ ] 11.1 フロントエンドバリデーション
  - プレイヤー数入力の範囲チェック(4-6)とエラーメッセージ表示
  - 無効な操作(他プレイヤーのターン中の開始)のUI無効化
  - API呼び出しエラー時のユーザー通知(トースト表示等)
  - _要件: 1.2_

- [ ] 11.2 バックエンド高度なエラーハンドリング
  - 500エラー: Cosmos DB接続失敗時のリトライロジック(3回、指数バックオフ)
  - 503エラー: SignalRメッセージ数上限到達時のエラーレスポンス
  - _要件: すべての要件の高度なエラー処理_

- [ ] 11.3 SignalR接続エラー対応
  - 接続失敗時の自動再接続(withAutomaticReconnect)
  - 再接続中のUI表示(ローディングスピナー等)
  - 再接続成功後の状態同期(GET /api/gameで最新状態取得)
  - _要件: 5.2_

- [ ] 12. テストの実装
- [ ] 12.1 フロントエンドユニットテスト(Vitest)
  - GameTimer状態管理ロジックのテスト
  - formatElapsedTime関数のMM:SS変換テスト
  - PlayerListコンポーネントのレンダリングテスト
  - アクティブプレイヤーハイライト表示のテスト
  - _要件: 2.1, 3.2_

- [ ] 12.2 バックエンドユニットテスト(Jest)
  - GameStateService.switchTurnビジネスルール検証テスト
  - GameStateService.updatePlayersバリデーションテスト
  - CosmosDbRepository CRUD操作のモックテスト
  - SignalRPublisherイベント送信のモックテスト
  - _要件: 3.3, 3.4, 1.2_

- [ ] 12.3 API統合テスト
  - POST /api/switchTurn → Cosmos DB更新 → SignalRイベント送信フロー
  - POST /api/resetGame → タイマー初期化フロー
  - SignalR接続→イベント受信→状態同期フロー
  - _要件: 5.1, 5.2_

- [ ] 12.4 E2Eテスト(Playwright)
  - 基本操作フロー: アプリ起動→ターン開始→タイマー動作→ターン切り替え
  - 複数デバイス同期: 2つのブラウザタブで同時アクセス→片方で操作→もう片方でリアルタイム反映
  - リセット機能: ゲーム進行中→リセット→全タイマー0:00確認
  - レスポンシブ表示: モバイル(375px)とデスクトップ(1920px)のレイアウト確認
  - _要件: すべての要件の統合動作確認_

- [ ] 13. パフォーマンス最適化
  - Code Splitting(React.lazy)によるバンドルサイズ削減
  - React.memoによる不要な再レンダリング防止
  - SignalRへのバッチ送信(複数イベント集約)
  - Cosmos DBクエリの最適化(PartitionKey + RowKey直接指定)
  - CDNキャッシュ設定(静的アセット max-age=31536000)
  - _要件: すべての要件のパフォーマンス向上_

- [ ] 14. セキュリティ対策
  - Rate Limiting設定(Azure Functions: 100リクエスト/分/IP)
  - HTTPS強制(Azure Static Web Apps標準)
  - SignalR接続のTLS 1.2以上強制
  - 入力バリデーション(Zodスキーマ)の全APIエンドポイント適用
  - _要件: すべての要件のセキュリティ確保_

- [ ] 15. モニタリングとロギング
  - Azure Application Insights統合(Free Tier 5GB/月)
  - API呼び出しログ記録(INFO レベル)
  - エラーログ記録(ERROR レベル: 500系、WARN レベル: 422)
  - SignalR接続状態の定期監視(60秒ごと)
  - ヘルスチェックエンドポイント(Azure Functions標準)の設定
  - _要件: すべての要件の運用監視_
