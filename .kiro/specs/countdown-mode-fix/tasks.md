# 実装計画: カウントダウンモード動作修正

### TDD実装プロセス（必須）
各タスクの実装時は以下のTDDプロセスに従うこと：
1. **RED phase**: 実装前にテストケースを作成
2. **GREEN phase**: 最小限の実装でテストをパス
3. **REFACTOR phase**: 必要に応じてリファクタリング
4. `npm test`で全テストが成功することを確認

## Phase 1: フォールバックモード（ローカル状態管理）の検証と修正

- [ ] 1. フォールバックモードのカウントダウン初期化を検証する
- [ ] 1.1 カウントダウンモード選択時の初期化ロジックを検証する
  - タイマーモードをカウントダウンに設定した時に全プレイヤーの時間が初期値に設定されることをテスト
  - カウントダウン秒数（例: 600秒）が正しく全プレイヤーに反映されることを確認
  - カウントアップモード選択時に全プレイヤーの時間が0秒に設定されることを確認（リグレッションテスト）
  - ユニットテストでタイマーモード切り替え関数の動作を検証
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 1.2 カウントダウンタイマーの減少動作を検証する
  - アクティブプレイヤーのタイマーが1秒ごとに1減少することをテスト
  - カウントダウンモード時に非アクティブプレイヤーの時間が変わらないことを確認
  - 一時停止中はタイマーが減少しないことを確認
  - 再開時にタイマー減少が再開されることを確認
  - Math.max(0, ...)により0秒以下にならないことを検証
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 1.3 0秒到達時の自動停止動作を実装する
  - タイマーが0秒に達した時にアクティブプレイヤーが解除されることをテスト
  - 全プレイヤーのisActiveフラグがfalseに設定されることを確認
  - タイマー停止後に次の1秒タイマーが実行されないことを検証
  - 0秒到達前後の状態遷移が正しいことを確認（エッジケース）
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 2. フォールバックモードのタイマー表示を検証する
- [ ] 2.1 カウントダウンタイマーのMM:SS形式表示を検証する
  - 600秒が"10:00"として表示されることをテスト
  - 599秒が"09:59"として表示されることをテスト
  - 0秒が"00:00"として表示されることをテスト
  - 負の値（異常状態）が"00:00"として表示されることを確認（防御的プログラミング）
  - formatTime関数のエッジケースを網羅的にテスト
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

## Phase 2: 通常モード（API連携）のバックエンド実装

- [ ] 3. バックエンドAPIのカウントダウンモード対応を実装する
- [ ] 3.1 バックエンドのタイマー計算ロジックを拡張する
  - カウントダウンモード時の残り時間計算ロジックを実装
  - 計算式: `elapsedTimeSeconds = countdownSeconds - accumulatedSeconds - currentTurnElapsedSeconds`
  - カウントアップモードの既存計算ロジックは変更しない（リグレッション防止）
  - タイマーモード判定分岐を追加
  - ユニットテストでカウントアップ/ダウン両モードの計算を検証
  - _Requirements: 2.6, 5.2, 5.4_

- [ ] 3.2 バックエンドの0秒到達時の自動停止を実装する
  - 残り時間が0秒以下に達した時にactivePlayerIndexを-1に設定
  - 全プレイヤーのisActiveフラグをfalseに設定
  - 0秒到達前後の状態遷移をテスト
  - GET /api/gameレスポンスに正しい停止状態が反映されることを確認
  - _Requirements: 4.5_

- [ ] 3.3 POST /api/updateGameのカウントダウンモード対応を実装する
  - リクエストパラメータにtimerMode='countdown'とcountdownSecondsを受け付ける
  - タイマーモード変更時に全プレイヤーの時間をリセット
  - バリデーション: countdownSecondsが1〜86400の範囲であることを検証
  - 範囲外の場合は400 Bad Requestを返す
  - ユニットテストでバリデーションとモード変更を検証
  - _Requirements: 1.5, 7.1_

- [ ] 4. 通常モードのフロントエンド同期を検証する
- [ ] 4.1 ポーリング同期によるカウントダウン表示を検証する
  - GET /api/gameレスポンスのelapsedTimeSecondsが残り時間として表示されることをテスト
  - 5秒ポーリング間隔でサーバー状態が正しく反映されることを確認
  - ローカル時間補間により1秒ごとの表示更新が行われることを検証
  - カウントダウンモード時の計算式が正しいことを確認
  - _Requirements: 2.6, 5.4_

- [ ] 4.2 タイマーモード変更のAPI連携を検証する
  - カウントダウンモード選択時にPOST /api/updateGame APIが呼び出されることをテスト
  - リクエストパラメータに{timerMode: 'countdown', countdownSeconds}が含まれることを確認
  - レスポンスのETagが正しく更新されることを検証
  - useServerGameState.updateFromServerで状態が反映されることを確認
  - _Requirements: 5.2_

## Phase 3: エラーハンドリングとエッジケースの実装

- [ ] 5. エラーハンドリングを実装する
- [ ] 5.1 ETag不在時の警告処理を実装する
  - 通常モードでETagが存在しない場合にコンソール警告を出力
  - 警告メッセージ: "ETag not available, cannot change timer mode"
  - API呼び出しをスキップして安全に処理を中断
  - ユニットテストで警告出力とAPI呼び出しスキップを検証
  - _Requirements: 6.5, 7.4_

- [ ] 5.2 API競合エラー（409 Conflict）のハンドリングを検証する
  - 409 Conflictレスポンス時に最新状態へロールバック
  - 競合メッセージをユーザーに表示
  - latestStateが正しくuseServerGameStateに反映されることを確認
  - ユニットテストで競合シナリオを検証
  - _Requirements: 7.2_

- [ ] 5.3 API失敗時のフォールバック切り替えを検証する
  - 3回連続API失敗時にフォールバックモードに自動切り替え
  - フォールバック警告バナーが表示されることを確認
  - useGameStateのローカル状態管理に切り替わることを検証
  - ユニットテストでフォールバック切り替えロジックを検証
  - _Requirements: 5.6, 7.3_

- [ ] 6. UI制御とフィードバックを実装する
- [ ] 6.1 タイマーモードトグルの無効化ロジックを検証する
  - ゲーム開始後（少なくとも1プレイヤーのelapsedTimeSeconds > 0）にトグルが無効化されることをテスト
  - リセット後にトグルが再度有効化されることを確認
  - disabled属性が正しく設定されることを検証
  - ツールチップメッセージが表示されることを確認
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 6.2 カウントダウン秒数入力フィールドの表示制御を検証する
  - タイマーモードが'countdown'の時に入力フィールドが表示されることをテスト
  - タイマーモードが'countup'の時に入力フィールドが非表示になることをテスト
  - 条件付きレンダリングが正しく機能することを確認
  - ゲーム開始後に入力フィールドが無効化されることを確認
  - _Requirements: 8.1, 8.2, 8.3_

- [ ] 6.3 0秒到達時の視覚的インジケーターを実装する
  - アクティブプレイヤーのタイマーが0秒に達した時にプレイヤーカードに視覚的変化を追加
  - 色の変化またはアイコン表示による明確なフィードバック
  - UIコンポーネントの条件付きスタイル適用を実装
  - E2Eテストで視覚的インジケーターを検証
  - _Requirements: 8.4_

## Phase 4: 統合テストとE2E検証

- [ ] 7. E2Eテストでカウントダウンモード全体を検証する
- [ ] 7.1 フォールバックモードのカウントダウンフローをE2Eテストで検証する
  - タイマーモードトグルをON → カウントダウン秒数入力（600秒） → ゲーム開始
  - 全プレイヤーの表示時間が"10:00"であることを確認
  - 1秒待機 → アクティブプレイヤーの表示時間が"09:59"に減少することを確認
  - タイマーを1秒まで進める → 1秒待機 → "00:00"で停止することを確認
  - Playwrightでブラウザ実機テストを実行
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 4.1, 4.2, 4.3_

- [ ] 7.2 通常モードのカウントダウンフローをE2Eテストで検証する
  - タイマーモードトグルをON → POST /api/updateGame APIが呼び出されることを確認
  - レスポンスで{timerMode: 'countdown', countdownSeconds: 600}が返ることを確認
  - ゲーム開始 → 5秒待機（ポーリング実行） → タイマーが減少していることを確認
  - Chrome DevTools Networkタブでポーリングリクエストを確認
  - E2Eテストで通常モードのカウントダウン動作を検証
  - _Requirements: 1.5, 2.6, 5.2, 5.4_

- [ ] 7.3 エッジケースと異常系をE2Eテストで検証する
  - 2つのクライアントで同時にタイマーモード変更 → 409 Conflictシナリオ
  - 競合メッセージ表示 → 最新状態へロールバック確認
  - API 3回連続失敗 → フォールバックモード自動切り替え確認
  - 0秒到達時の視覚的インジケーター表示確認
  - E2Eテストで全エッジケースを網羅
  - _Requirements: 5.6, 7.2, 7.3, 8.4_

## Phase 5: 最終検証と実装完了

- [ ] 8. 実装完了処理を実施する
- [ ] 8.1 全テスト結果の確認
  - 全てのユニットテストが成功していることを確認（`npm test`）
  - 全てのE2Eテストが成功していることを確認（`npx playwright test`）
  - カウントアップモードの既存動作が変わっていないことを確認（リグレッションテスト）
  - エラーや予期しない動作が発生しないことを確認
  - _Requirements: All requirements_

- [ ] 8.2 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _Requirements: All requirements_
