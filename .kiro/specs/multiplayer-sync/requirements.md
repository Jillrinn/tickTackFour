# Requirements Document

## はじめに

本機能は、既存のインメモリータイマー（multiplayer-game-timer Phase 1完了）に、マルチプレイヤー同期機能を追加します。Cosmos DB Table APIによる永続化、バックエンド主導の時間計算、ポーリング同期を実装し、複数デバイス間でゲーム状態を共有できるようにします。

Azure無料層サービス（Cosmos DB Free Tier、Azure Functions Consumption Plan）を活用し、コスト0円での運用を実現します。

**注:** リアルタイム同期（SignalR Service）については、別仕様 `signalr-realtime-sync` として定義されています。

## 要件

### 要件1: ゲーム状態の永続化
**目的:** ゲーム参加者として、ブラウザをリロードしても前回のゲーム状態を復元できるようにすることで、中断せずにゲームを継続できるようにする

#### 受入基準
1. WHEN ゲームタイマーが起動した時 THEN マルチプレイヤー同期システムは Cosmos DB Table APIからゲーム状態を取得すること
2. IF Cosmos DBにゲーム状態が存在しない時 THEN マルチプレイヤー同期システムは デフォルトのゲーム状態（4人、カウントアップモード、全タイマー0:00）を初期化すること
3. WHEN タイマー操作（ターン切り替え、一時停止、再開、リセット）が実行された時 THEN マルチプレイヤー同期システムは 操作イベントをバックエンドに送信すること
4. WHEN バックエンドが操作イベントを受信した時 THEN マルチプレイヤー同期システムは 経過時間を計算しCosmos DBに保存すること
5. WHEN ブラウザをリロードした時 THEN マルチプレイヤー同期システムは Cosmos DBから前回の状態（タイマー値、アクティブプレイヤー、タイマーモード、プレイヤー数）を復元すること
6. IF 複数デバイスから同じゲームにアクセスした時 THEN マルチプレイヤー同期システムは 各デバイスで同じCosmos DBのゲーム状態を参照すること
7. WHEN Cosmos DB接続に失敗した時 THEN マルチプレイヤー同期システムは エラーメッセージを表示しインメモリーモードで動作を継続すること

### 要件1.5: 経過時間計算（バックエンド責務）
**目的:** ゲーム参加者として、ブラウザのリロードやスリープ状態に関係なく正確な経過時間を取得できるようにすることで、時間の整合性を保証する

#### 受入基準
1. WHEN バックエンドがゲーム状態を取得する時 THEN マルチプレイヤー同期システムは ターン開始時刻と現在時刻から経過時間を計算すること
2. WHEN 一時停止状態でない AND アクティブプレイヤーの時 THEN マルチプレイヤー同期システムは 累積経過時間 + (現在時刻 - ターン開始時刻) を返すこと
3. WHEN 一時停止状態 OR 非アクティブプレイヤーの時 THEN マルチプレイヤー同期システムは 累積経過時間のみを返すこと
4. WHEN ターン切り替え操作を受信した時 THEN マルチプレイヤー同期システムは 現在の経過時間を計算し累積経過時間に加算すること
5. WHEN 一時停止操作を受信した時 THEN マルチプレイヤー同期システムは 現在の経過時間を計算し累積経過時間に加算し一時停止時刻を記録すること
6. WHEN 再開操作を受信した時 THEN マルチプレイヤー同期システムは 新しいターン開始時刻を記録し一時停止状態を解除すること
7. WHEN フロントエンドがゲーム状態を取得した時 THEN マルチプレイヤー同期システムは バックエンドで計算された経過時間を表示すること
8. WHEN フロントエンドが操作イベントを送信する時 THEN マルチプレイヤー同期システムは 経過時間を含めずに操作種別のみを送信すること

### 要件2: ポーリング同期
**目的:** ゲーム参加者として、複数デバイスで手動リロードせずに最新の状態を確認できるようにすることで、デバイス間の状態の不一致を最小化する

#### 受入基準
1. WHILE アプリケーションが起動中 THE マルチプレイヤー同期システムは 5秒ごとにCosmos DBからゲーム状態を取得すること
2. WHEN ポーリングで最新の状態を取得した時 THEN マルチプレイヤー同期システムは UIを最新の状態に更新すること
3. IF ポーリング中にネットワークエラーが発生した時 THEN マルチプレイヤー同期システムは 現在の状態を保持し次回のポーリングを継続すること
4. WHEN 他のデバイスでタイマー操作が実行された時 AND 5秒以内にポーリングが実行された時 THEN マルチプレイヤー同期システムは 変更を反映すること

### 要件3: 楽観的ロック制御
**目的:** システム管理者として、複数デバイスからの同時更新による競合を検出できるようにすることで、データ整合性を保証する

#### 受入基準
1. WHEN Cosmos DBからゲーム状態を取得した時 THEN マルチプレイヤー同期システムは ETagを記録すること
2. WHEN ゲーム状態を更新する時 THEN マルチプレイヤー同期システムは 記録したETagを使用して楽観的ロック更新を実行すること
3. IF 楽観的ロック競合が発生した時 THEN マルチプレイヤー同期システムは 最新の状態を取得し再試行すること
4. IF 3回の再試行後も競合が解決しない時 THEN マルチプレイヤー同期システムは エラーメッセージを表示し手動リロードを促すこと

### 要件4: Azure Functions API統合
**目的:** システム管理者として、Azure Functions（Managed Functions in Static Web Apps）を通じてCosmos DBにアクセスできるようにすることで、セキュアかつスケーラブルなバックエンドを提供する

#### 受入基準
1. WHERE Azure Functions API THE マルチプレイヤー同期システムは GET /api/game エンドポイントでゲーム状態を取得できること
2. WHERE Azure Functions API THE マルチプレイヤー同期システムは POST /api/updateGame エンドポイントでゲーム状態を更新できること
3. WHERE Azure Functions API THE マルチプレイヤー同期システムは POST /api/switchTurn エンドポイントでターン切り替えを実行できること
4. WHERE Azure Functions API THE マルチプレイヤー同期システムは POST /api/pauseGame エンドポイントで一時停止を実行できること
5. WHERE Azure Functions API THE マルチプレイヤー同期システムは POST /api/resumeGame エンドポイントで再開を実行できること
6. WHERE Azure Functions API THE マルチプレイヤー同期システムは POST /api/resetGame エンドポイントでリセットを実行できること
7. WHEN Azure Functions APIがエラーを返した時 THEN マルチプレイヤー同期システムは エラーメッセージをユーザーに表示すること
8. WHERE Azure Functions API THE マルチプレイヤー同期システムは CORS設定でフロントエンドドメインからのアクセスを許可すること

### 要件5: 無料層リソース制約対応
**目的:** システム管理者として、Azure無料層の制約内でシステムが安定動作するようにすることで、コスト0円での運用を維持する

#### 受入基準
1. WHERE Cosmos DB Free Tier THE マルチプレイヤー同期システムは 1000 RU/s以内で動作すること（現在約2.5 RU/s使用）
2. WHERE Azure Functions Consumption Plan THE マルチプレイヤー同期システムは 月100万リクエスト以内で動作すること
3. WHEN リソース使用量が上限に近づいた時 THEN マルチプレイヤー同期システムは 警告メッセージを表示すること

### 要件6: エラーハンドリングとフォールバック
**目的:** ゲーム参加者として、ネットワークエラーやサービス障害時にも基本機能を使用できるようにすることで、信頼性の高い体験を提供する

#### 受入基準
1. WHEN Azure Functions APIが利用不可の時 THEN マルチプレイヤー同期システムは インメモリーモードで動作を継続すること
2. WHEN Cosmos DB接続が失敗した時 THEN マルチプレイヤー同期システムは ローカルストレージに状態を保存すること
3. WHERE エラー発生時 THE マルチプレイヤー同期システムは ユーザーに分かりやすいエラーメッセージと復旧手順を表示すること
4. WHEN フォールバックモード（インメモリー）で動作中 THE マルチプレイヤー同期システムは 通常モード（Cosmos DB同期）への復帰を定期的に試行すること
5. WHEN Cosmos DB接続が復帰した時 THEN マルチプレイヤー同期システムは 自動的にCosmos DB同期に切り替えること
