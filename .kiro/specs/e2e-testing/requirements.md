# Requirements Document

## はじめに

本仕様は、マルチプレイヤー・ゲームタイマーアプリケーションに対するE2Eテスト環境を構築するためのものです。現在のフロントエンド実装（Phase 1: インメモリー版）に対するE2Eテストを実装し、将来的なバックエンド統合（Azure Functions + Cosmos DB + SignalR）を考慮した拡張可能なテストアーキテクチャを確立します。

### ビジネス価値
- **品質保証**: ユーザー視点での完全な動作検証により、本番環境での不具合を最小化
- **リグレッション防止**: 新機能追加時に既存機能が壊れないことを自動検証
- **CI/CD統合**: 自動テスト実行によるデプロイ前の品質ゲート確立
- **将来への投資**: バックエンド統合時にスムーズに移行できるテストアーキテクチャ

## Requirements

### Requirement 1: E2Eテストインフラストラクチャの構築
**Objective:** テストエンジニアとして、Playwright を使用したE2Eテスト環境を構築し、フロントエンドアプリケーションの完全な動作検証を自動化したい。これにより、継続的な品質保証とリグレッション防止が実現できる。

#### Acceptance Criteria

1. WHEN プロジェクトルートで `npm run test:e2e` コマンドを実行 THEN E2Eテストシステム SHALL Playwright を使用して全E2Eテストを実行する
2. WHEN E2Eテストが実行される THEN E2Eテストシステム SHALL ヘッドレスモードで Chrome、Firefox、Safari の3ブラウザでテストを実行する
3. WHEN `npm run test:e2e:ui` コマンドを実行 THEN E2Eテストシステム SHALL Playwright UI モードでインタラクティブなテスト実行とデバッグを提供する
4. WHERE テスト実行中 THE E2Eテストシステム SHALL 各テストケースのスクリーンショットと実行トレースを自動保存する
5. IF E2Eテストが失敗した場合 THEN E2Eテストシステム SHALL 失敗時点のスクリーンショット、DOM状態、コンソールログを記録する
6. WHEN E2Eテストの設定を定義する THEN E2Eテストシステム SHALL `playwright.config.ts` にベースURL、タイムアウト、リトライ戦略、ブラウザ設定を含む
7. WHERE テストファイルを配置する場合 THE E2Eテストシステム SHALL `frontend/e2e/` ディレクトリ内に `*.spec.ts` パターンでテストファイルを配置する

### Requirement 2: プレイヤー管理機能のE2Eテスト
**Objective:** QAエンジニアとして、プレイヤー数の変更とプレイヤーカード表示の動作を完全に検証したい。これにより、ユーザーがプレイヤー管理機能を正しく使用できることを保証できる。

#### Acceptance Criteria

1. WHEN ユーザーがアプリケーションに初回アクセス THEN アプリケーション SHALL デフォルトで4人のプレイヤーを表示する
2. WHEN ユーザーが「5人」ボタンをクリック THEN アプリケーション SHALL 5人のプレイヤーカードを表示する
3. WHEN ユーザーが「6人」ボタンをクリック THEN アプリケーション SHALL 6人のプレイヤーカードを表示する
4. WHEN ユーザーが「4人」ボタンをクリック THEN アプリケーション SHALL 4人のプレイヤーカードを表示する
5. WHERE 各プレイヤーカード THE アプリケーション SHALL プレイヤー名、プレイヤーID（先頭8文字）、経過時間を表示する
6. WHEN プレイヤー数を変更 THEN アプリケーション SHALL 各プレイヤーの経過時間を0秒にリセットする
7. WHEN プレイヤー数を変更 THEN アプリケーション SHALL アクティブプレイヤーをnullにリセットする

### Requirement 3: タイマー動作のE2Eテスト
**Objective:** QAエンジニアとして、カウントアップ/カウントダウンモードのタイマー動作を正確に検証したい。これにより、タイマーの計測精度とモード切り替えの正確性を保証できる。

#### Acceptance Criteria

1. WHEN ユーザーが「カウントアップ」ボタンをクリック THEN アプリケーション SHALL タイマーモードを「count-up」に設定する
2. WHEN カウントアップモードでプレイヤーがアクティブになる THEN アプリケーション SHALL そのプレイヤーの経過時間を1秒ごとに増加させる
3. WHEN ユーザーが「カウントダウン」ボタンをクリック AND カウントダウン秒数が600秒に設定されている THEN アプリケーション SHALL タイマーモードを「count-down」に設定し、各プレイヤーの残り時間を600秒に初期化する
4. WHEN カウントダウンモードでプレイヤーがアクティブになる THEN アプリケーション SHALL そのプレイヤーの残り時間を1秒ごとに減少させる
5. WHEN カウントダウンモードでプレイヤーの残り時間が0秒に達する THEN アプリケーション SHALL そのプレイヤーカードに「timeout」クラスを付与する
6. WHEN ユーザーがカウントダウン秒数入力フィールドに300を入力 THEN アプリケーション SHALL カウントダウン秒数を300秒に設定する
7. WHERE タイマー動作中 THE アプリケーション SHALL 経過時間を「MM:SS」フォーマット（例: 05:23）で表示する

### Requirement 4: プレイヤー操作のE2Eテスト
**Objective:** QAエンジニアとして、アクティブプレイヤーの設定、ターン切り替え、時間調整の動作を検証したい。これにより、ゲームプレイ中の操作が正しく機能することを保証できる。

#### Acceptance Criteria

1. WHEN ユーザーがプレイヤーカードの「アクティブに設定」ボタンをクリック THEN アプリケーション SHALL そのプレイヤーをアクティブプレイヤーに設定する
2. WHEN プレイヤーがアクティブになる THEN アプリケーション SHALL そのプレイヤーカードに「active」クラスを付与する
3. WHEN ユーザーが「次のプレイヤーへ」ボタンをクリック THEN アプリケーション SHALL アクティブプレイヤーを次の順序のプレイヤーに切り替える
4. WHEN ユーザーが最後のプレイヤーで「次のプレイヤーへ」ボタンをクリック THEN アプリケーション SHALL アクティブプレイヤーを最初のプレイヤーに切り替える
5. WHEN ユーザーがプレイヤーカードの「+10秒」ボタンをクリック THEN アプリケーション SHALL そのプレイヤーの経過時間に10秒を追加する
6. WHEN ユーザーが「アクティブ解除」ボタンをクリック THEN アプリケーション SHALL アクティブプレイヤーをnullに設定する
7. IF カウントダウンモードでプレイヤーがタイムアウトした場合 THEN アプリケーション SHALL そのプレイヤーの「アクティブに設定」と「+10秒」ボタンを無効化する

### Requirement 5: ゲーム制御機能のE2Eテスト
**Objective:** QAエンジニアとして、一時停止/再開、リセット機能の動作を検証したい。これにより、ゲーム全体の制御が正しく機能することを保証できる。

#### Acceptance Criteria

1. WHEN ユーザーが「一時停止」ボタンをクリック THEN アプリケーション SHALL タイマーの進行を停止し、ボタンテキストを「再開」に変更する
2. WHEN ユーザーが「再開」ボタンをクリック THEN アプリケーション SHALL タイマーの進行を再開し、ボタンテキストを「一時停止」に変更する
3. WHEN ゲームが一時停止中 THEN アプリケーション SHALL アクティブプレイヤーの時間を更新しない
4. WHEN ユーザーが「リセット」ボタンをクリック THEN アプリケーション SHALL 全プレイヤーの経過時間を0秒にリセットする
5. WHEN ユーザーが「リセット」ボタンをクリック THEN アプリケーション SHALL アクティブプレイヤーをnullにリセットする
6. WHEN ユーザーが「リセット」ボタンをクリック THEN アプリケーション SHALL 一時停止状態をfalseにリセットする
7. WHEN ユーザーが「リセット」ボタンをクリック THEN アプリケーション SHALL タイマーモードを「count-up」にリセットする

### Requirement 6: レスポンシブUIのE2Eテスト
**Objective:** QAエンジニアとして、異なる画面サイズでのUIレイアウトとレスポンシブ動作を検証したい。これにより、全デバイスで最適な表示と操作性を保証できる。

#### Acceptance Criteria

1. WHEN ビューポート幅が375px以下の場合 THEN アプリケーション SHALL プレイヤーカードを単列レイアウトで表示する
2. WHEN ビューポート幅が768px以上の場合 THEN アプリケーション SHALL プレイヤーカードを2列グリッドレイアウトで表示する
3. WHEN ビューポート幅が1024px以上の場合 THEN アプリケーション SHALL プレイヤーカードを3列グリッドレイアウトで表示する
4. WHEN ビューポート幅が1440px以上の場合 THEN アプリケーション SHALL プレイヤーカードを4列グリッドレイアウトで表示する
5. WHERE 全ての画面サイズ THE アプリケーション SHALL 読みやすいフォントサイズ（最小14px）を維持する
6. WHERE 全ての画面サイズ THE アプリケーション SHALL タップしやすいボタンサイズ（最小44×44px）を維持する
7. WHEN ビューポートサイズが変更される THEN アプリケーション SHALL スムーズにレイアウトを再配置する

### Requirement 7: 将来のバックエンド統合を考慮したテストアーキテクチャ
**Objective:** アーキテクトとして、将来的なバックエンド（Azure Functions + Cosmos DB + SignalR）統合時にスムーズに移行できるテストアーキテクチャを設計したい。これにより、フロントエンドのみのテストから完全なエンドツーエンドテストへの拡張が容易になる。

#### Acceptance Criteria

1. WHERE テストファイルを構造化する場合 THE E2Eテストシステム SHALL フロントエンド専用テスト（`frontend-only/`）とフルスタックテスト（`full-stack/`）を分離したディレクトリ構造を採用する
2. WHEN テストでデータアクセスが必要な場合 THEN テストコード SHALL データアクセスレイヤー（`test/fixtures/` または `test/helpers/`）を経由してデータを取得する
3. WHERE 現在のフロントエンドのみのテスト THE テストコード SHALL モックデータまたはローカルストレージを使用してバックエンド依存を回避する
4. WHEN 将来バックエンドAPIが実装される場合 THEN テストコード SHALL 環境変数（`TEST_MODE=frontend-only|full-stack`）でテストモードを切り替える
5. WHERE フルスタックテストを準備する場合 THE テストアーキテクチャ SHALL API呼び出し、SignalR接続、データベース状態検証を含むテストパターンの雛形を含む
6. WHEN テストセットアップとティアダウンを実装 THEN テストコード SHALL 各テストの独立性を保証するためのクリーンアップ処理を含む
7. WHERE テストデータを管理する場合 THE E2Eテストシステム SHALL 再利用可能なテストフィクスチャ（プレイヤー設定、ゲーム状態）を `test/fixtures/` に配置する

### Requirement 8: テストレポートとCI/CD統合
**Objective:** DevOpsエンジニアとして、E2Eテストの実行結果を可視化し、CI/CDパイプラインに統合したい。これにより、自動化された品質ゲートとデプロイ前の検証を実現できる。

#### Acceptance Criteria

1. WHEN E2Eテストが完了 THEN E2Eテストシステム SHALL HTML形式のテストレポートを `playwright-report/` ディレクトリに生成する
2. WHEN E2Eテストが完了 THEN E2Eテストシステム SHALL JUnit XML形式のテストレポートを `test-results/` ディレクトリに生成する
3. WHERE CI/CD環境（GitHub Actions） THE E2Eテストシステム SHALL プルリクエスト作成時に自動的にE2Eテストを実行する
4. IF E2Eテストが失敗した場合 AND CI/CD環境で実行されている THEN E2Eテストシステム SHALL デプロイプロセスを停止し、失敗をプルリクエストにコメントする
5. WHEN CI/CD環境でE2Eテストを実行 THEN E2Eテストシステム SHALL テスト成果物（スクリーンショット、トレース、ビデオ）をGitHub Artifactsにアップロードする
6. WHERE ローカル開発環境 THE E2Eテストシステム SHALL テスト失敗時に自動的にPlaywright Traceビューアを起動する
7. WHEN テストカバレッジを測定 THEN E2Eテストシステム SHALL 主要ユーザーフロー（プレイヤー管理、タイマー操作、ゲーム制御）の100%カバレッジを達成する

### Requirement 9: テストメンテナンスとベストプラクティス
**Objective:** テストエンジニアとして、保守性の高いE2Eテストコードを維持したい。これにより、テストの長期的な価値と信頼性を確保できる。

#### Acceptance Criteria

1. WHERE テストコードを実装する場合 THE テストコード SHALL Page Object Modelパターンを採用し、UI要素のセレクターを集約する
2. WHEN 共通操作を実装する場合 THEN テストコード SHALL 再利用可能なヘルパー関数（例: `waitForPlayerCount()`, `setActivePlayer()`）を提供する
3. WHERE テストのセットアップとティアダウン THE テストコード SHALL `beforeEach` フックでアプリケーションを初期状態にリセットする
4. WHEN テストでタイミングに依存する操作を行う場合 THEN テストコード SHALL Playwrightの自動待機機能（`waitFor`, `expect`）を使用し、任意の `sleep()` を避ける
5. WHERE UI要素を選択する場合 THE テストコード SHALL `data-testid` 属性を優先的に使用し、実装詳細に依存しないセレクターを採用する
6. WHEN テストが失敗した場合 THEN テストコード SHALL 明確なエラーメッセージと期待値・実際値を含むアサーション失敗情報を提供する
7. WHERE テストケースを文書化する場合 THE テストコード SHALL `test.describe` と `test()` で明確なテストシナリオと検証内容を記述する
