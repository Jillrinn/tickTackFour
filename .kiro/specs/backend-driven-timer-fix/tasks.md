# 実装計画

### TDD実装プロセス（必須）
各タスクの実装時は以下のTDDプロセスに従うこと：
1. **RED phase**: 実装前にテストケースを作成
2. **GREEN phase**: 最小限の実装でテストをパス
3. **REFACTOR phase**: 必要に応じてリファクタリング
4. `npm test`で全テストが成功することを確認

## Phase 1: 表示時間計算ロジックの修正

- [x] 1. 表示時間計算を修正し、二重カウントを排除する機能を実装
  - ポーリング同期時に取得したサーバー累積時間を基準点として設定
  - ポーリング間の経過時間のみをサーバー累積時間に加算する計算ロジックを実装
  - 既存のターン開始時刻ベースの計算から、最終同期時刻ベースの計算に変更
  - アクティブプレイヤーとゲーム開始前の状態で適切に分岐処理
  - **TDD実装**: ユニットテストケース作成 → 実装 → `npm test`で全テストパス確認
  - **完了条件**: TypeScriptコンパイルエラーなし、ブラウザで二重カウント解消を確認
  - _Requirements: 4.3, 5.3_

## Phase 2: サーバー同期時のタイマー再構築機能

- [x] 2. サーバー同期時にタイマー状態を完全リセットする機能を実装
  - GET同期ごとに既存のタイマーインスタンスを破棄
  - サーバーから取得した累積時間を基準点として設定
  - 表示時間とターン時間を初期化（サーバー情報に完全同期）
  - 最終同期時刻を現在時刻で記録
  - アクティブプレイヤーとゲーム開始前の状態で適切に初期化
  - **TDD実装**: ユニットテストケース作成 → 実装 → `npm test`で全テストパス確認
  - **完了条件**: GET同期ごとにタイマーがリセットされることをブラウザで確認
  - _Requirements: 4.1, 4.2, 5.1, 5.2_

## Phase 3: E2Eテスト（最終テストフェーズ）

- [ ] 3. バグ修正を検証するE2Eテストを実装
- [ ] 3.1 「5秒ごとに5秒加算される」バグ修正の検証テストを作成
  - ゲーム開始後、5秒ごとにポーリング同期が実行されることを確認
  - 各ポーリング後、表示時間が正しく更新されることを確認（二重カウントなし）
  - 10秒経過後、表示時間が約10秒であることを確認（20秒ではないこと）
  - 30秒経過後、表示時間が約30秒であることを確認（累積誤差なし）
  - _Requirements: 4.3, 5.3_

- [ ] 3.2 タイマー表示の正確性検証テストを作成
  - プレイヤーカード経過時間が正しく表示されることを検証
  - ターン時間が正しく表示されることを検証
  - 全体プレイ時間が正しく表示されることを検証
  - ポーリング間（5秒間）のタイマー表示が滑らかに増加することを検証
  - _Requirements: 4.3, 5.3, 6.3, 6.4_

- [ ] 3.3 ターン切り替え時の動作検証テストを作成
  - ターン切り替え後、新しいプレイヤーのタイマーが0秒から開始されることを検証
  - 前のプレイヤーの累積時間が正しく保存されることを検証
  - ターン切り替え後のポーリング同期で二重カウントが発生しないことを検証
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 3.4 一時停止/再開時の動作検証テストを作成
  - 一時停止中、タイマーが停止することを検証
  - 再開後、タイマーが正しく再開されることを検証
  - 一時停止中の時間が経過時間に含まれないことを検証
  - 一時停止/再開時にポーリング同期との整合性が保たれることを検証
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 3.5 E2Eテスト完了確認
  - **完了条件**: 全E2Eテストがパス（`npx playwright test`）
  - **完了条件**: 「5秒ごとに5秒加算される」バグが完全に解消されていること
  - **完了条件**: タイマー表示が正確で、視覚的にスムーズに動作すること

## Phase 4: 実装完了処理

- [ ] 4. 実装完了処理を実施する
- [ ] 4.1 全テスト結果の確認
  - 全てのユニットテストが成功していることを確認（`npm test`）
  - 全てのE2Eテストが成功していることを確認（`npx playwright test`）
  - エラーや予期しない動作が発生しないことを確認

- [ ] 4.2 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果、バグ修正の確認を含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _Requirements: 全要件_
