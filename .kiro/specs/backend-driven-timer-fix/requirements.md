# Requirements Document

## Introduction

現在のマルチプレイヤー・ゲームタイマーには、ポーリング同期時にフロントエンドとバックエンドの時刻計算が二重にカウントされる問題があり、「5秒ごとに5秒加算される」バグが発生しています。本機能では、**バックエンド主導のアーキテクチャ**に移行することで、この問題を根本的に解決します。

フロントエンドのタイマーは**表示専用**として扱い、すべての時刻計算とゲーム状態管理はバックエンドで行います。フロントエンドからバックエンドへのリクエストには時刻情報を含めず、バックエンドが計算した最新の状態をGETリクエストで取得して表示を更新します。

この設計により、時刻計算の信頼できる情報源（Single Source of Truth）がバックエンドに一元化され、フロントエンドとバックエンドの時刻のずれが発生しなくなります。

## Requirements

### Requirement 1: バックエンド主導の時刻計算

**Objective:** システム管理者として、すべての時刻計算がバックエンドで行われることを望む、それにより時刻計算の一貫性が保証される

#### Acceptance Criteria

1. WHEN ゲーム状態が更新されたとき THEN バックエンド SHALL プレイヤーの経過時間を計算する
2. WHEN アクティブプレイヤーが切り替わったとき THEN バックエンド SHALL ターン開始時刻を記録する
3. WHEN ゲーム状態が取得されたとき THEN バックエンド SHALL 現在時刻を基準に各プレイヤーの経過時間を計算して返す
4. WHERE バックエンドの時刻計算処理 THE バックエンド SHALL 唯一の信頼できる情報源として機能する

### Requirement 2: フロントエンドの時刻情報送信禁止

**Objective:** システム管理者として、フロントエンドからバックエンドへのリクエストに時刻情報が含まれないことを望む、それにより二重カウントを防止する

#### Acceptance Criteria

1. WHEN フロントエンドがターン切り替えをリクエストするとき THEN フロントエンド SHALL 時刻情報を送信しない
2. WHEN フロントエンドが一時停止/再開をリクエストするとき THEN フロントエンド SHALL 時刻情報を送信しない
3. WHEN フロントエンドがゲーム状態を更新するとき THEN フロントエンド SHALL プレイヤーIDや操作種別のみを送信する
4. IF フロントエンドのリクエストに時刻情報が含まれている場合 THEN バックエンド SHALL その時刻情報を無視する

### Requirement 3: バックエンド主導のターン切り替え処理

**Objective:** プレイヤーとして、ターン切り替え処理がバックエンドで完結することを望む、それによりフロントエンドとバックエンドの状態の不一致を防止する

#### Acceptance Criteria

1. WHEN フロントエンドが次のプレイヤーへのターン切り替えをリクエストしたとき THEN バックエンド SHALL 現在のアクティブプレイヤーの経過時間を確定する
2. WHEN バックエンドが現在のプレイヤーの経過時間を確定したとき THEN バックエンド SHALL 次のプレイヤーをアクティブに設定する
3. WHEN バックエンドが次のプレイヤーをアクティブに設定したとき THEN バックエンド SHALL 新しいターンの開始時刻を記録する
4. WHEN バックエンドがターン切り替え処理を完了したとき THEN バックエンド SHALL 更新されたゲーム状態を返す

### Requirement 4: フロントエンドの表示専用タイマー

**Objective:** プレイヤーとして、フロントエンドのタイマーがサーバーの情報を正確に表示することを望む、それにより時刻のずれがなくなる

#### Acceptance Criteria

1. WHEN フロントエンドがGETリクエストでゲーム状態を取得したとき THEN フロントエンド SHALL 既存のタイマーインスタンスを破棄する
2. WHEN フロントエンドが既存のタイマーを破棄したとき THEN フロントエンド SHALL サーバーから取得した時刻情報を基準に新しいタイマーを設定する
3. WHILE タイマーが実行中のとき THE フロントエンド SHALL サーバーから取得した時刻情報を基準に表示時間を計算する
4. WHERE フロントエンドのタイマー THE フロントエンド SHALL 表示専用として扱い、計算結果をバックエンドに送信しない

### Requirement 5: GET同期時のタイマー再構築

**Objective:** システム管理者として、GET同期のたびにタイマーが再構築されることを望む、それによりサーバーの情報と表示の一貫性が保証される

#### Acceptance Criteria

1. WHEN ポーリング同期でGETリクエストが実行されたとき THEN フロントエンド SHALL 現在のタイマーをクリアする
2. WHEN サーバーからゲーム状態を取得したとき THEN フロントエンド SHALL サーバーのターン開始時刻（turnStartedAt）を基準にタイマーを再設定する
3. WHEN タイマーを再設定したとき THEN フロントエンド SHALL サーバーの経過時間とフロントエンドの現在時刻の差分を計算して表示する
4. IF サーバーが一時停止状態の場合 THEN フロントエンド SHALL タイマーを停止状態で表示する

### Requirement 6: バックエンドのゲーム状態管理

**Objective:** システム管理者として、バックエンドがゲーム状態の唯一の信頼できる情報源として機能することを望む、それにより状態の一貫性が保証される

#### Acceptance Criteria

1. WHEN バックエンドがゲーム状態を保存するとき THEN バックエンド SHALL 各プレイヤーの累積経過時間を記録する
2. WHEN バックエンドがゲーム状態を保存するとき THEN バックエンド SHALL アクティブプレイヤーのターン開始時刻を記録する
3. WHEN バックエンドがゲーム状態を取得するとき THEN バックエンド SHALL 現在時刻とターン開始時刻の差分を計算してアクティブプレイヤーの現在の経過時間を算出する
4. WHEN バックエンドがゲーム状態を返すとき THEN バックエンド SHALL 計算された経過時間を含む最新の状態を返す

### Requirement 7: 一時停止/再開処理の整合性

**Objective:** プレイヤーとして、一時停止/再開処理がバックエンドで正しく処理されることを望む、それにより一時停止中の時間が経過時間に含まれない

#### Acceptance Criteria

1. WHEN フロントエンドが一時停止をリクエストしたとき THEN バックエンド SHALL 一時停止時刻（pausedAt）を記録する
2. WHEN バックエンドが一時停止時刻を記録したとき THEN バックエンド SHALL アクティブプレイヤーの累積経過時間を確定して保存する
3. WHEN フロントエンドが再開をリクエストしたとき THEN バックエンド SHALL 一時停止期間を計算してターン開始時刻を調整する
4. WHEN バックエンドがターン開始時刻を調整したとき THEN バックエンド SHALL 一時停止中の時間が経過時間に含まれないようにする

### Requirement 8: エラーハンドリングとフォールバック

**Objective:** システム管理者として、バックエンドとの通信エラー時にフロントエンドが適切に動作することを望む、それによりユーザー体験が損なわれない

#### Acceptance Criteria

1. WHEN バックエンドへのGETリクエストが失敗したとき THEN フロントエンド SHALL 既存の表示を維持する
2. WHEN バックエンドへのPOSTリクエストが失敗したとき THEN フロントエンド SHALL エラーメッセージを表示する
3. IF バックエンドへのリクエストが連続して失敗する場合 THEN フロントエンド SHALL フォールバックモードに切り替える
4. WHERE フォールバックモード THE フロントエンド SHALL ローカルのuseGameStateフックを使用してゲーム状態を管理する

### Requirement 9: API仕様の明確化

**Objective:** 開発者として、バックエンドAPIの仕様が明確に定義されることを望む、それによりフロントエンドとバックエンドの統合が容易になる

#### Acceptance Criteria

1. WHEN POST /api/switchTurnが呼ばれたとき THEN バックエンド SHALL リクエストボディに時刻情報を要求しない
2. WHEN POST /api/pauseが呼ばれたとき THEN バックエンド SHALL サーバー側の現在時刻で一時停止処理を実行する
3. WHEN GET /api/gameが呼ばれたとき THEN バックエンド SHALL 計算された最新の経過時間を含むゲーム状態を返す
4. WHERE APIレスポンス THE バックエンド SHALL turnStartedAt、pausedAt、各プレイヤーのelapsedSecondsを含む

### Requirement 10: 後方互換性の保証

**Objective:** システム管理者として、既存のフォールバックモード（useGameState）が引き続き動作することを望む、それにより段階的な移行が可能になる

#### Acceptance Criteria

1. WHEN フロントエンドがフォールバックモードで動作しているとき THEN フロントエンド SHALL 既存のuseGameStateフックを使用する
2. WHEN フロントエンドが通常モード（API連携）で動作しているとき THEN フロントエンド SHALL 新しいバックエンド主導の処理を使用する
3. WHERE 通常モードとフォールバックモード THE フロントエンド SHALL 同じUIコンポーネントを共有する
4. IF APIモードで接続エラーが発生した場合 THEN フロントエンド SHALL フォールバックモードに自動切り替えする
