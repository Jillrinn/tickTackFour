# Requirements Document

## Project Description (Input)
e2eテストを実行し、現在どこに問題があるかを確認してください。現状の画面に関しては問題がないため、それぞれの失敗について何が原因なのかのレポートを作成し、テストを修正するべきなのか実装を修正するべきなのか私の判断を仰いでください。

## E2Eテスト失敗分析レポート

### テスト実行結果サマリー
- **合計テスト数**: 96個
- **成功**: 17個
- **失敗**: 69個
- **スキップ**: 10個

### 根本原因

**問題**: Page Objectのセレクターと実装のHTML構造の不一致

#### 詳細分析

**Page Object (`e2e/pages/GameTimerPage.ts:41`)**:
```typescript
this.gameHeader = page.locator('.game-header');  // ← 存在しないクラス
```

**実際の実装 (`frontend/src/components/GameTimer.tsx:409`)**:
```tsx
<div className="sticky-header" data-testid="sticky-header">
  {/* ヘッダーコンテンツ */}
</div>
```

**影響範囲**: 全てのテストの `beforeEach` フックで `verifyPageLoaded()` が実行され、`.game-header` を30秒間待ってタイムアウトする。

### 失敗テスト一覧

#### 1. アクティブプレイヤー操作機能 (7件全て失敗)
- プレイヤーをアクティブに設定できる
- 次のプレイヤーへ順番に切り替えられる
- 最後のプレイヤーから最初のプレイヤーへ循環する
- +10秒ボタンで経過時間が10秒増加する
- 次のプレイヤーへ切り替えると元のアクティブプレイヤーが解除される
- アクティブプレイヤーがいる時、他のプレイヤーのボタンが無効化される
- タイムアウト時にtimeoutクラスが付与される

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 2. ゲーム制御機能 (7件全て失敗)
- 一時停止ボタンでタイマーが停止する
- 再開ボタンでタイマーが再開する
- 一時停止/再開ボタンのテキストが切り替わる
- 一時停止中はタイマーが停止する
- リセットボタンで全状態がリセットされる
- リセット後にプレイヤーをアクティブにできる
- リセット後、タイマーが完全に停止していることを確認

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 3. プレイヤー管理機能 (8件全て失敗)
- デフォルトで4人のプレイヤーが表示される
- プレイヤー数を5人に変更できる
- プレイヤー数を6人に変更できる
- プレイヤー数を4人に戻せる
- 各プレイヤーカードに名前、経過時間が表示される
- プレイヤー数を増やすと新しいプレイヤーが追加される
- プレイヤー数を減らすと末尾のプレイヤーが削除される
- プレイヤー名を変更できる

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 4. プレイヤー名永続化機能 (7件全て失敗)
- プレイヤー名入力フィールドフォーカス時に履歴が表示される
- 履歴から名前を選択すると入力フィールドに設定される
- プレイヤー名変更後のゲームリセット時に名前が保存される
- ページリロード後に履歴が反映される
- 500エラー時にプルダウンが空のまま動作する
- API障害時も通常のテキスト入力が可能である
- API障害時にエラーUI通知が表示されない

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 5. レスポンシブUI機能 (7件全て失敗)
- 375px幅で単列レイアウトが適用される
- 768px幅で2列グリッドレイアウトが適用される
- 1024px幅で3列グリッドレイアウトが適用される
- 1440px幅で4列グリッドレイアウトが適用される
- 全画面サイズでフォントサイズが14px以上
- 全画面サイズでボタンが十分なサイズで表示される
- ビューポート変更時にレイアウトが再配置される

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 6. タイマー動作機能 (6件全て失敗)
- カウントアップモードでタイマーが進行する
- カウントダウンモードでタイマーが減少する
- カウントダウンモードで残り時間0秒でタイムアウトする
- カウントダウン秒数をカスタマイズできる
- 経過時間がMM:SSフォーマットで表示される
- カウントアップからカウントダウンへの切り替えができる

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 7. ターン時間トラッキング機能 (14件中14件失敗、1件スキップ)
- アクティブプレイヤーのカードに「現在のターン」が表示される
- ターン時間が1秒ごとに更新される（MM:SS形式）
- 非アクティブプレイヤーのカードには「現在のターン」が表示されない
- 次のプレイヤーへ切り替え時、前のプレイヤーのターン時間が消え、新しいプレイヤーのターン時間が表示される
- 固定ヘッダーに「ゲーム全体のプレイ時間」が表示される
- ゲーム全体時間が1秒ごとに更新される
- 1時間未満はMM:SS形式で表示される
- リセット時に"00:00"にリセットされる
- 一時停止時にターン時間とゲーム全体時間の更新が停止する
- 再開時にターン時間とゲーム全体時間の更新が再開する
- 一時停止中の時間がターン時間に含まれない
- モバイル（375px）でターン時間とゲーム全体時間が適切に表示される
- タブレット（768px）でターン時間とゲーム全体時間が適切に表示される
- PC（1440px）でターン時間とゲーム全体時間が適切に表示される

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 8. UI Controls Enhancement (16件全て失敗)
- プレイヤー人数ドロップダウンで4人→5人→6人に変更できる
- プレイヤー人数変更時、既存のプレイヤー時間データが保持される
- ゲーム進行中はプレイヤー人数ドロップダウンが無効化される
- カウントモードトグルスイッチでカウントアップ⇔カウントダウンを切り替えられる
- カウントダウンモード時、設定UIが表示される
- ゲーム進行中はカウントモードトグルが無効化される
- 固定ヘッダーが常に表示される
- ゲーム未開始時、固定ヘッダーに「ゲーム未開始」と表示される
- 次のプレイヤーへボタンクリック時、固定ヘッダー情報が更新される
- 固定ヘッダーの次のプレイヤーへボタンでターン切り替えができる
- ページスクロール後も固定ヘッダーが画面上部に表示される
- モバイル (375px) で全UIコントロールが表示され操作可能
- タブレット (768px) で全UIコントロールが表示され操作可能
- PC (1024px) で全UIコントロールが表示され操作可能
- 大画面 (1440px) で全UIコントロールが表示され操作可能
- タイマー開始→設定無効化→一時停止→設定有効化フロー

**原因**: `.game-header` セレクターが見つからずタイムアウト
**修正方法**: テスト修正

#### 9. スモークテスト (3件中2件成功、1件失敗)
- ✓ 3ブラウザでの実行を検証
- ✓ スクリーンショット機能を検証
- ✗ アプリケーションが正常にロードされる

**失敗の原因**:
```
Error: page.locator: Error: strict mode violation: locator('.game-timer') resolved to 2 elements
```

**修正方法**: テスト修正（セレクターの厳密化）

#### 10. ONEmore Turn ブランディング (9件全て成功 ✓)
- ブラウザタブのタイトルが「ONEmore Turn」である
- ファビコンが正しく読み込まれる
- アプリ画面上部にヘッダーロゴが表示される
- アプリ画面上部にタイトルテキストが表示される
- スマートフォンサイズ（375px）でロゴサイズが適切に調整される
- タブレットサイズ（768px）でロゴサイズが適切に調整される
- PCサイズ（1024px）でロゴサイズが適切に調整される
- 大画面サイズ（1440px）でロゴサイズが適切に調整される
- アクセシビリティ: alt属性が設定されている
- アクセシビリティ: セマンティックHTMLが使用されている

**成功理由**: 独立したテストで `.game-header` を使用していない

#### 11. マルチプレイヤー同期機能（Phase 2）(10件全てスキップ)
- デバイスAでターン切り替え→5秒後デバイスBで反映
- デバイスAで一時停止→5秒後デバイスBで反映
- デバイスAでプレイヤー数変更→5秒後デバイスBで反映
- リロード後にゲーム状態が復元される
- リロード後にプレイヤー数とモードが復元される
- リロード後に一時停止状態が復元される
- 同時更新時に412 Conflictエラーが検出される
- API停止時にインメモリーモードで動作継続
- API復旧時に自動的にCosmos DB同期に切り替わる
- ポーリングエラー後も次回ポーリングを継続

**スキップ理由**: テストに `test.skip()` が設定されている（Phase 2実装が未完了の可能性）

### 修正方針の判断

#### 実装を修正するべきか？
**❌ NO** - 実装は正しく動作しており、ユーザーに問題はない。画面は正常に表示され、全ての機能が期待通りに動作している。

#### テストを修正するべきか？
**✅ YES** - Page Objectのセレクターが実装のHTML構造と一致していない。テスト側を修正する必要がある。

### 推奨修正内容

#### 必須修正: Page Object セレクター更新

**ファイル**: `e2e/pages/GameTimerPage.ts`

**修正内容**:
```typescript
// 修正前
this.gameHeader = page.locator('.game-header');

// 修正後
this.gameHeader = page.getByTestId('sticky-header');
// または
this.gameHeader = page.locator('.sticky-header');
```

**理由**:
- 実装では `.sticky-header` クラスと `data-testid="sticky-header"` が使用されている
- `data-testid` を使用する方が、CSS変更に強く、より安定したテストになる

#### 推奨修正: smoke.spec.ts の厳密化

**ファイル**: `e2e/specs/smoke.spec.ts`

**問題**: `.game-timer` が2つの要素にマッチしている

**修正内容**:
```typescript
// 修正前
await expect(page.locator('.game-timer')).toBeVisible();

// 修正後
await expect(page.locator('.game-timer').first()).toBeVisible();
// または
await expect(page.getByRole('main')).toBeVisible();
```

### 実装確認（参考情報）

**実際のHTML構造**:
```tsx
<div className="game-timer">
  <main className="game-main">
    <div className="sticky-header" data-testid="sticky-header">
      <div className="sticky-header-content" data-testid="sticky-header-content">
        ...
      </div>
    </div>
    <div className="players-section">
      ...
    </div>
    <div className="controls-section" data-testid="controls-section">
      ...
    </div>
  </main>
</div>
```

**利用可能なdata-testid**:
- `sticky-header`
- `sticky-header-content`
- `active-player-info`
- `total-game-time`
- `controls-section`
- `settings-controls`
- `turn-time`

### 次のステップ

1. Page Objectのセレクターを修正
2. smoke.spec.tsの厳密化
3. 全E2Eテストを再実行して成功を確認

## Requirements
<!-- Will be generated in /kiro:spec-requirements phase -->