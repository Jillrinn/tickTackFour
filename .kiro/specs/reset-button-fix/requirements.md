# Requirements Document

## Introduction

マルチプレイヤー・ゲームタイマーのリセットボタン機能に不具合が発生しています。現在、リセットボタンを押下しても、カウントアップ・カウントダウンのタイマーが停止せず、時間計測が継続してしまう問題があります。

本仕様では、リセットボタンが正しく機能するように修正し、以下の期待動作を実現します：
- 全てのプレイヤーの時間をリセット（カウントアップモードは0秒、カウントダウンモードは初期時間に戻す）
- ゲームを完全に停止状態にする（タイマーの動作を停止し、アクティブプレイヤーをクリア）
- UIに停止状態を正しく反映する

この修正により、ユーザーはゲームを確実にリセットして新しいゲームを開始できるようになり、タイマーの信頼性が向上します。

## Requirements

### Requirement 1: リセットボタン押下時のゲーム状態リセット
**Objective:** ゲーム進行中のユーザーとして、リセットボタンを押下したとき、全てのプレイヤーの時間がリセットされ、ゲームが完全に停止状態になることを期待します。これにより、新しいゲームを確実に開始できるようになります。

#### Acceptance Criteria

1. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL 全てのプレイヤーの経過時間をタイマーモードに応じてリセットする（カウントアップモードは0秒、カウントダウンモードは各プレイヤーの初期設定時間）
2. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL アクティブプレイヤーIDをnullに設定する
3. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL ゲーム一時停止状態フラグ（isPaused）をtrueに設定する
4. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL 一時停止時刻（pausedAt）をnullに設定する
5. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL 全てのプレイヤーのアクティブ状態フラグ（isActive）をfalseに設定する
6. WHEN ユーザーがリセットボタンを押下する THEN ゲームタイマーシステム SHALL 全てのプレイヤーのターン開始時刻（turnStartedAt）をnullに設定する

### Requirement 2: タイマー動作の完全停止
**Objective:** ゲーム進行中のユーザーとして、リセットボタンを押下したとき、タイマーのカウントアップ・カウントダウンが即座に停止することを期待します。これにより、リセット後に時間が勝手に進むことを防ぎます。

#### Acceptance Criteria

1. WHEN ゲーム状態がリセットされる（activePlayerId が null かつ isPaused が true） THEN タイマー管理システム SHALL 実行中のタイマーインターバルを即座にクリアする
2. IF タイマーインターバルが実行中である THEN タイマー管理システム SHALL リセット後にタイマーインターバルが再起動されないことを保証する
3. WHEN リセット後にゲーム状態が更新される THEN タイマー管理システム SHALL useGameTimerフックのuseEffect依存配列によりタイマー停止条件を再評価する

### Requirement 3: UI状態の正確な反映
**Objective:** ゲーム進行中のユーザーとして、リセットボタンを押下したとき、UI上で停止状態が正しく表示されることを期待します。これにより、ゲームが停止していることを視覚的に確認できます。

#### Acceptance Criteria

1. WHEN ゲームがリセットされる THEN UIコンポーネント SHALL 一時停止/再開ボタンに「一時停止」状態を表示する（isPausedがtrueのため）
2. WHEN ゲームがリセットされる THEN UIコンポーネント SHALL 全てのプレイヤーカードからアクティブ状態のハイライト表示を削除する
3. WHEN ゲームがリセットされる THEN UIコンポーネント SHALL 全てのプレイヤーの時間表示をリセット値に更新する（カウントアップは「00:00」、カウントダウンは初期時間）
4. WHEN ゲームがリセットされる THEN UIコンポーネント SHALL ゲーム全体のプレイ時間表示を「00:00」にリセットする

### Requirement 4: リセット機能の既存動作保持
**Objective:** 開発者として、リセット機能の修正が既存の正常に動作している機能（プレイヤー名履歴保存等）に影響を与えないことを期待します。これにより、バグ修正による副作用を防ぎます。

#### Acceptance Criteria

1. WHEN ゲームがリセットされる THEN ゲームタイマーシステム SHALL デフォルト名以外のプレイヤー名をプレイヤー名履歴に保存する（既存のTask 8機能）
2. WHEN ゲームがリセットされる AND フォールバックモード（テストモード）が有効である THEN ゲームタイマーシステム SHALL フォールバックステートのresetGame()メソッドを呼び出す
3. WHEN ゲームがリセットされる AND サーバー同期モードが有効である THEN ゲームタイマーシステム SHALL /api/reset エンドポイントを呼び出してサーバー側の状態もリセットする

### Requirement 5: エラーハンドリングとロバスト性
**Objective:** 開発者として、リセット処理中にエラーが発生した場合でも、システムが安定した状態を保つことを期待します。これにより、ユーザー体験の信頼性が向上します。

#### Acceptance Criteria

1. WHEN リセット処理中にエラーが発生する THEN ゲームタイマーシステム SHALL エラー内容をコンソールに記録する
2. IF サーバー同期モードでETagが利用できない THEN ゲームタイマーシステム SHALL 警告メッセージを表示してリセット処理を中断する
3. WHEN サーバー側リセットAPIが412 Conflict を返す THEN ゲームタイマーシステム SHALL 競合メッセージを表示してユーザーに再読み込みを促す

### Requirement 6: 初期状態からのゲーム開始処理
**Objective:** ゲームリセット後のユーザーとして、「次のプレイヤーへ」ボタンを押下したとき、ゲームが正常に開始し、最初のプレイヤーのタイマーが動作することを期待します。これにより、リセット後に新しいゲームをスムーズに開始できます。

#### Acceptance Criteria

1. WHEN activePlayerIndexが-1（初期状態/ゲーム未開始）の状態で次のプレイヤーへボタンが押下される THEN POST /api/switchTurn エンドポイント SHALL 初期状態を検出する
2. WHEN 初期状態が検出される THEN POST /api/switchTurn エンドポイント SHALL 前のプレイヤーの時間加算処理をスキップする（プレイヤーが存在しないため）
3. WHEN 初期状態が検出される THEN POST /api/switchTurn エンドポイント SHALL activePlayerIndexを0に設定する（最初のプレイヤーをアクティブに）
4. WHEN 初期状態が検出される THEN POST /api/switchTurn エンドポイント SHALL isPausedをfalseに設定する（ゲーム開始）
5. WHEN 初期状態が検出される THEN POST /api/switchTurn エンドポイント SHALL turnStartedAtを現在時刻（ISO8601形式）に設定する
6. WHEN 初期状態からゲームを開始する THEN ゲームタイマーシステム SHALL エラーなく正常に応答する（500エラーを返さない）
