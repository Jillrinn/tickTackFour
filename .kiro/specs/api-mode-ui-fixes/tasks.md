# 実装計画

## Phase 1: UI視認性の修正

- [x] 1. 設定セクションのテキストカラーを修正する
  - GameTimer.cssの`.settings-controls`クラスに`color: #212121`を追加
  - WCAG 2.1 AAレベル（コントラスト比16.1:1）を満たすテキストカラーを明示的に設定
  - 変更箇所: `frontend/src/components/GameTimer.css` lines 769-776
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. 視認性修正の検証を実施する
- [x] 2.1 ブラウザでAPIモードの視認性を手動確認
  - 開発サーバーを起動し、APIモードで動作させる
  - 設定セクション（プレイヤー人数、タイマーモード、カウントダウン設定等）のテキストが読めることを確認
  - ラベル、ボタンテキスト、ドロップダウンの視認性を確認
  - _要件: 1.1, 1.2, 1.5_

- [ ] 2.2 E2Eテストで視認性を自動検証
  - Playwrightで設定セクションのテキスト要素を取得
  - 各テキスト要素のcolor プロパティが`#212121`または`#333`であることを検証
  - コントラスト比が4.5:1以上であることを確認（可能であれば）
  - _要件: 1.3, 1.4_

## Phase 2: プレイヤー名編集機能の実装

- [x] 3. useGameApiフックにプレイヤー名更新機能を追加する
- [x] 3.1 updatePlayerName関数を実装
  - バックエンドAPI `/api/updatePlayerName` を呼び出す関数を実装
  - リクエストパラメータ: `playerIndex`, `name`, `etag`
  - レスポンス処理: 成功時（200 OK）、競合時（409 Conflict）、バリデーションエラー時（400 Bad Request）、サーバーエラー時（5xx）
  - 楽観的ロック用のETagを含める
  - _要件: 2.3, 4.1, 4.2_

- [x] 3.2 updatePlayerName関数のユニットテストを作成
  - 正常系: プレイヤー名更新成功（200 OK）のテスト
  - 異常系: ETag不一致（409 Conflict）のテスト
  - 異常系: バリデーションエラー（400 Bad Request）のテスト
  - 異常系: ネットワークタイムアウトのテスト
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 4. バックエンドAPI `PUT /api/updatePlayerName` を実装する
- [x] 4.1 updatePlayerName.ts 関数ファイルを作成
  - **ファイル**: `api/src/functions/updatePlayerName.ts`
  - 既存の `switchTurn.ts` パターンを参考に実装
  - リクエストボディから `playerIndex`, `name` を取得
  - `If-Match` ヘッダーから `etag` を取得
  - Cosmos DB から現在のゲーム状態（GAME_STATE）を取得
  - **バリデーション**:
    - `playerIndex`: 0 ≤ playerIndex < players.length
    - `name`: 1文字以上、100文字以下
    - `etag`: 必須（楽観的ロック用）
  - `players[playerIndex].name` を新しい名前で更新
  - 楽観的ロック（ETag）を使用してCosmos DBに保存
  - 新しいETagと更新後のゲーム状態をレスポンス
  - _要件: 2.3, 4.1, 4.2_

- [ ] 4.2 エラーハンドリングを実装
  - **409 Conflict**: ETag不一致時、最新状態を含むエラーレスポンスを返す
  - **400 Bad Request**: バリデーション失敗時、詳細メッセージを返す
    - `playerIndex` が範囲外
    - `name` が空文字または100文字超過
    - `etag` が未指定
  - **412 Precondition Failed**: Cosmos DB楽観的ロック失敗
  - **500 Internal Server Error**: その他のエラー（Cosmos DB接続エラー等）
  - _要件: 4.3, 4.4_

- [ ] 4.3 updatePlayerName エンドポイントのユニットテストを作成
  - **ファイル**: `api/src/functions/__tests__/updatePlayerName.test.ts`
  - **正常系**:
    - プレイヤー名更新成功（200 OK）
    - 正しいETagと更新後の状態が返される
  - **異常系**:
    - ETag不一致（409 Conflict）: 最新状態が返される
    - playerIndex範囲外（400 Bad Request）
    - name空文字（400 Bad Request）
    - name 101文字（400 Bad Request）
    - etag未指定（400 Bad Request）
    - Cosmos DBエラー（500 Internal Server Error）
  - 既存の `switchTurn.test.ts` パターンを参考に実装
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 5. GameTimerコンポーネントにプレイヤー名編集UIを追加する
- [x] 5.1 APIモードセクションのプレイヤー名表示をinputタグに変更
  - 変更箇所: `frontend/src/components/GameTimer.tsx` lines 384-428（APIモードセクション）
  - ゲーム開始前（`activePlayerIndex === -1`）の場合: `<input className="player-name-input">`
  - ゲーム開始後（`activePlayerIndex !== -1`）の場合: `<span className="player-name">`（既存のまま）
  - `disabled={isGameActive}` 属性を追加してゲーム中の編集を無効化
  - _要件: 2.1, 2.2, 2.4_

- [x] 5.2 プレイヤー名入力時のAPI呼び出しロジックを実装
  - onChangeハンドラ `handlePlayerNameChange` を実装
  - 楽観的更新: ローカル状態を即座に更新（UIに即反映）
  - デバウンス処理: 300ms後にuseGameApi.updatePlayerNameを呼び出し
  - エラー処理: API失敗時にローカル状態を元の値にロールバック、エラーメッセージ表示
  - _要件: 2.3, 2.6, 4.1, 4.4_

- [ ] 5.3 プレイヤー名履歴をdatalistで表示
  - `<datalist id="player-name-history-api-{index}">` をAPIモードセクションに追加
  - `list` 属性でdatalistを参照
  - onFocusハンドラで `handlePlayerNameFocus` を呼び出し、履歴を取得
  - フォールバックモードと同じ履歴管理フック `usePlayerNameHistory` を使用
  - _要件: 2.5, 3.2_

- [ ] 5.4 エラーハンドリングUIを実装
  - 409 Conflict時: モーダルダイアログで「他のユーザーが更新しました」表示、最新状態にロールバック
  - 400 Bad Request時: 入力フィールド下に赤文字でバリデーションエラーメッセージ表示
  - 500 Internal Server Error時: トーストメッセージで「更新に失敗しました」表示
  - ネットワークタイムアウト時: リトライボタン付きエラーメッセージ表示
  - _要件: 4.3, 4.4_

## Phase 3: 統合テストとE2Eテスト

- [ ] 6. プレイヤー名編集機能の統合テストを作成する
- [ ] 6.1 プレイヤー名編集UIの表示テスト
  - APIモードでゲーム開始前にinputタグが表示されることをテスト
  - APIモードでゲーム開始後にspanタグが表示されることをテスト
  - フォールバックモードとAPIモードで同じUI構造であることをテスト
  - _要件: 2.1, 2.2, 2.4, 3.1, 3.2_

- [ ] 6.2 プレイヤー名編集とAPI呼び出しのテスト
  - プレイヤー名変更後300ms以内にAPI呼び出しが実行されることをテスト
  - 楽観的更新によりUIが即座に更新されることをテスト
  - API成功時にUIが更新されたままであることをテスト
  - _要件: 2.3, 2.6_

- [ ] 6.3 プレイヤー名履歴表示のテスト
  - プレイヤー名入力フィールドにフォーカス時に履歴が取得されることをテスト
  - datalistに履歴が表示されることをテスト
  - フォールバックモードとAPIモードで同じ履歴が表示されることをテスト
  - _要件: 2.5, 3.2_

- [ ] 7. プレイヤー名編集機能のE2Eテストを作成する
- [ ] 7.1 ゲーム開始前のプレイヤー名編集E2Eテスト
  - APIモードでゲーム開始前にプレイヤー名を編集できることをテスト
  - プレイヤー名入力後にUIに即座に反映されることをテスト
  - 5秒以内に他のブラウザタブでも更新されることをテスト（ポーリング同期）
  - _要件: 2.1, 2.2, 2.3, 2.6_

- [ ] 7.2 ゲーム開始後のプレイヤー名編集不可E2Eテスト
  - APIモードでゲーム開始後にプレイヤー名が編集不可であることをテスト
  - プレイヤー名がspanタグで表示されることをテスト
  - inputタグが表示されないことをテスト
  - _要件: 2.4, 3.3_

- [ ] 7.3 エラーハンドリングE2Eテスト
  - 409 Conflict時に競合エラーモーダルが表示されることをテスト
  - ローカル状態が最新状態にロールバックされることをテスト
  - 400 Bad Request時にバリデーションエラーメッセージが表示されることをテスト
  - 500 Internal Server Error時にトーストメッセージが表示されることをテスト
  - _要件: 4.3, 4.4_

- [ ] 7.4 デバウンス機能のE2Eテスト
  - 10文字連続入力時にAPI呼び出しが1回のみであることをテスト
  - 最後の入力から300ms後にAPI呼び出しが実行されることをテスト
  - _要件: 2.3_

## Phase 4: 最終検証と実装完了

- [ ] 8. 全機能の最終検証を実施する
- [ ] 8.1 全ユニットテストの実行と確認
  - `npm test` を実行し、全てのユニットテストが成功することを確認
  - useGameApi.updatePlayerNameのテストが全て成功することを確認
  - テストカバレッジが80%以上であることを確認
  - _要件: 全要件_

- [ ] 8.2 全E2Eテストの実行と確認
  - `npx playwright test` を実行し、全てのE2Eテストが成功することを確認
  - 視認性テスト、プレイヤー名編集テスト、エラーハンドリングテストが全て成功することを確認
  - デバウンステストが成功することを確認
  - _要件: 全要件_

- [ ] 8.3 実装完了処理を実施する
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
  - _要件: 全要件_
