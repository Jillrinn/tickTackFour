# 要件定義書

## はじめに

APIモード（通常モード）において、以下の2つの重大なユーザビリティ問題が発生しています：

1. **UI視認性の問題**: 白背景に白文字が表示され、UIが読みづらくなっている
2. **プレイヤー名編集の制限**: ゲーム開始前にプレイヤー名を編集できない

これらの問題により、APIモードでのユーザー体験が著しく低下しています。本仕様では、これらの問題を解決し、フォールバックモードと同等の使いやすさをAPIモードでも実現します。

### ビジネス価値

- **ユーザー体験の向上**: APIモードでもフォールバックモードと同等の使いやすさを提供
- **アクセシビリティの改善**: WCAG 2.1コントラスト基準（4.5:1以上）に準拠したUI
- **機能の一貫性**: 両モード間での機能差異を解消し、統一されたユーザー体験を実現

## 要件

### 要件1: APIモードにおけるUI視認性の確保

**目的**: ユーザーとして、APIモードにおいて明瞭で読みやすいUIを利用したい。これにより、ゲームコントロールや設定項目を容易に視認・理解できる。

#### 受入基準

1. **WHEN** APIモード（通常モード）で動作している **THEN** GameTimerは全てのUIテキストを背景に対して十分なコントラストで表示すること

2. **WHEN** 設定コントロール（.settings-controls）をAPIモードで表示する **THEN** GameTimerは全てのテキスト要素が読みやすいことを保証すること

3. **WHERE** UI要素が白色または明るい背景を持つ **THEN** GameTimerは暗色のテキスト色を使用し、最低4.5:1のコントラスト比を確保すること

4. **WHEN** ラベル、ボタンテキスト、説明文を表示する **THEN** GameTimerはWCAG 2.1 AAレベルのコントラスト基準に準拠したスタイルを適用すること

5. **IF** ユーザーがAPIモードで設定セクションを操作する **THEN** GameTimerは全ての対話要素（ドロップダウン、トグルスイッチ、ボタン）のラベルと状態を明確に視認できるようにすること

### 要件2: APIモードにおけるゲーム開始前のプレイヤー名編集機能

**目的**: ユーザーとして、APIモードでゲーム開始前にプレイヤー名を編集したい。これにより、フォールバックモードと同様にプレイヤー名をカスタマイズできる。

#### 受入基準

1. **WHEN** APIモード（通常モード）で動作している **AND** ゲームが開始されていない（activePlayerIndex === -1） **THEN** GameTimerはプレイヤー名の編集を許可すること

2. **WHEN** ユーザーがプレイヤー名フィールドをクリックまたはタップする **AND** ゲームが開始されていない **THEN** GameTimerは編集可能な入力フィールドを表示すること

3. **WHEN** ユーザーがプレイヤー名を編集する **THEN** GameTimerはバックエンドAPIに更新リクエストを送信すること

4. **IF** ゲームがアクティブ（activePlayerIndex !== -1）である **THEN** GameTimerはプレイヤー名の編集を無効化すること

5. **WHEN** プレイヤー名入力フィールドがフォーカスを受ける **THEN** GameTimerはプレイヤー名履歴をdatalistとして表示すること

6. **WHEN** バックエンドAPIからのプレイヤー名更新が成功する **THEN** GameTimerは更新されたプレイヤー名をUIに即座に反映すること

7. **WHERE** プレイヤー名編集UIを実装する **THEN** GameTimerはフォールバックモードと同じUIコンポーネント（.player-name-input）を使用すること

### 要件3: モード間の一貫したユーザー体験

**目的**: ユーザーとして、フォールバックモードとAPIモードで一貫したユーザー体験を得たい。これにより、モード切り替え時の混乱を防ぐ。

#### 受入基準

1. **WHEN** フォールバックモードからAPIモードに切り替わる **THEN** GameTimerはUIの外観と動作を可能な限り一貫して保つこと

2. **WHERE** プレイヤー名編集機能を提供する **THEN** GameTimerは両モードで同一のUI要素とインタラクションパターンを使用すること

3. **IF** 機能がAPIモードで利用可能である **THEN** GameTimerはフォールバックモードと同じ操作方法を提供すること

### 要件4: バックエンドAPI連携

**目的**: 開発者として、プレイヤー名更新をバックエンドに永続化したい。これにより、複数デバイス間でのプレイヤー名の同期を実現する。

#### 受入基準

1. **WHEN** APIモードでプレイヤー名が編集される **THEN** GameTimerは適切なAPIエンドポイントにPUT/PATCHリクエストを送信すること

2. **WHEN** プレイヤー名更新APIリクエストを送信する **THEN** GameTimerは現在のETagを含めて楽観的ロックを実装すること

3. **IF** プレイヤー名更新APIリクエストが競合（409 Conflict）を返す **THEN** GameTimerは最新の状態を取得し、ユーザーに再試行を促すこと

4. **IF** プレイヤー名更新APIリクエストが失敗する **THEN** GameTimerはエラーメッセージを表示し、変更を元に戻すこと

5. **WHEN** プレイヤー名更新が成功する **THEN** GameTimerはポーリング同期により他のクライアントに変更を伝播すること
