# 実装タスク

## Phase 1: バックエンド基盤の構築

- [x] 1. Cosmos DB Table APIクライアントの設定
  - 既存のCosmosDB接続パターンを参照して、PlayerNamesテーブル用のクライアント作成関数を実装
  - 接続文字列のバリデーション機能を既存パターンから再利用
  - テーブル名を"PlayerNames"に設定し、TableClientインスタンスを返す関数を実装
  - _要件: 3.1, 3.2_

- [x] 2. データモデルと型定義の作成
  - PlayerNameEntity型定義（PartitionKey、RowKey、PlayerName、CreatedAt、Timestamp、ETagを含む）
  - PlayerNameResponse型定義（GET API用、nameとcreatedAtフィールド）
  - SavePlayerNamesRequest型定義（POST API用、names配列）
  - SavePlayerNamesResponse型定義（POST API用、savedCountフィールド）
  - RowKey生成ロジックの実装（逆順タイムスタンプ + GUID形式）
  - _要件: 3.3, 3.4, 3.5_

## Phase 2: バックエンドAPIエンドポイントの実装

- [x] 3. プレイヤー名バリデーション層の実装
  - 名前の長さチェック機能（1-50文字）
  - 重複名の除外ロジック
  - HTML特殊文字のサニタイゼーション（XSS対策）
  - 空文字列の除外処理
  - バリデーション結果を返す関数の実装
  - _要件: 10.1, 10.2_

- [ ] 4. GET /api/player-names エンドポイントの実装
- [x] 4.1 基本的な取得機能の実装
  - HTTP Trigger Function作成
  - Cosmos DBから最新40件を取得するクエリロジック
  - RowKey降順ソートによる最新順取得
  - レスポンスJSON形式への変換
  - _要件: 2.1, 2.2_

- [x] 4.2 エラーハンドリングの実装
  - Cosmos DB接続失敗時の500エラー返却
  - 読み取り失敗時の空配列返却
  - エラーログ記録機能
  - CORS ヘッダーの設定
  - _要件: 2.6, 8.6, 10.4_

- [ ] 5. POST /api/player-names エンドポイントの実装
- [x] 5.1 基本的な保存機能の実装
  - HTTP Trigger Function作成
  - リクエストボディのバリデーション呼び出し
  - Cosmos DBへの名前保存処理
  - 保存成功時のレスポンス返却（savedCount含む）
  - _要件: 2.3, 2.4_

- [x] 5.2 40件超過時の自動削除機能
  - 全エンティティ取得とRowKey昇順ソート（逆順タイムスタンプなので小さいほど古い）
  - 40件を超える古いエンティティの特定（配列の最初から = RowKeyが小さい）
  - 古いエンティティの削除処理
  - _要件: 1.4_

- [x] 5.3 エラーハンドリングの実装
  - バリデーションエラー時の400エラー返却（全て無効な名前の場合）
  - Cosmos DB書き込み失敗時の500エラー返却
  - RU/s制限超過時の503エラー返却（429エラーを503に変換）
  - Content-Type検証（application/json必須）
  - エラーログ記録機能（context.error呼び出し）
  - _要件: 2.5, 2.6, 8.5, 10.3_

## Phase 3: フロントエンド基盤の構築

- [x] 6. usePlayerNameHistory カスタムフックの実装
- [x] 6.1 基本的な取得機能の実装
  - セッションキャッシュ状態管理（useState）
  - GET /api/player-namesを呼び出す関数
  - キャッシュヒット時の即座返却ロジック
  - キャッシュミス時のAPI呼び出しとキャッシュ保存
  - _要件: 4.1, 9.4_

- [x] 6.2 保存機能とデバウンス処理の実装
  - POST /api/player-namesを呼び出す関数
  - 3秒間隔のデバウンス処理
  - デフォルト名（「プレイヤー1」等）の除外フィルタ
  - バックグラウンド保存（UI通知なし）
  - _要件: 1.5, 9.3_

- [x] 6.3 エラーハンドリングの実装
  - GET失敗時の空配列返却
  - POST失敗時のコンソールログ記録
  - 5秒タイムアウト処理（AbortController使用）
  - ネットワークエラー時のフォールバック
  - _要件: 8.1, 8.2, 8.3, 8.4_

## Phase 4: フロントエンドUI統合

- [ ] 7. プレイヤー名入力フィールドへの`<datalist>`統合
- [x] 7.1 基本的なUI実装
  - 既存の入力フィールドに`list`属性を追加
  - `<datalist>`要素の生成とユニークID設定
  - 履歴名のマッピングと`<option>`要素生成
  - usePlayerNameHistoryフックとの連携
  - _要件: 4.2, 4.3, 6.1_

- [x] 7.2 レスポンシブ対応
  - モバイルデバイスでのタップ領域確保
  - プルダウンの最大高さ制限とスクロール対応
  - タブレット・PCでのマウス・キーボード操作対応
  - _要件: 7.1, 7.2, 7.3_

- [x] 8. ゲームリセット・ブラウザ閉じる時の名前保存トリガー
  - ゲームリセットボタンクリック時のイベントハンドラ追加
  - ブラウザ閉じる前イベント（beforeunload）のハンドラ追加
  - デフォルト名以外のプレイヤー名を抽出
  - usePlayerNameHistoryのsaveNames関数呼び出し
  - _要件: 1.1, 1.2, 6.2_

## Phase 5: テストの実装

- [x] 9. バックエンドユニットテストの作成
- [x] 9.1 バリデーション層のテスト
  - 有効な名前の通過テスト
  - 空文字列の除外テスト
  - HTML特殊文字のエスケープテスト
  - 重複名の除外テスト
  - 51文字名の拒否テスト
  - _要件: 10.1, 10.2_

- [x] 9.2 GET /api/player-names のテスト
  - 40件取得成功テスト
  - 10件のみ存在時の10件返却テスト
  - Cosmos DB読み取り失敗時の空配列返却テスト
  - _要件: 2.1, 2.2, 8.6_

- [x] 9.3 POST /api/player-names のテスト
  - 有効な名前配列の保存成功テスト
  - バリデーションエラー時の400返却テスト
  - Cosmos DB書き込み失敗時の500返却テスト
  - 重複名の除外テスト
  - _要件: 2.3, 2.4, 2.5, 2.6_

- [x] 10. フロントエンドユニットテストの作成
- [x] 10.1 usePlayerNameHistory フックのテスト
  - 初回fetchNames呼び出しでAPI呼び出し実行テスト
  - 2回目fetchNames呼び出しでキャッシュ使用テスト
  - saveNamesデバウンス動作テスト
  - API失敗時の空配列返却テスト
  - _要件: 9.3, 9.4_

- [x] 10.2 プレイヤー名入力UIのテスト
  - `<datalist>`要素が正しく生成されるテスト
  - `<input list>`属性が正しく設定されるテスト
  - 履歴が空の場合のテスト
  - _要件: 4.2, 4.4_

- [ ] 11. E2Eテストの作成
- [ ] 11.1 プレイヤー名履歴取得と選択フローのテスト
  - プレイヤー名入力フィールドフォーカス時の履歴表示テスト
  - 履歴から名前選択時の入力フィールド設定テスト
  - _要件: 4.1, 4.3_

- [ ] 11.2 プレイヤー名保存フローのテスト
  - プレイヤー名変更後のゲームリセット時の保存テスト
  - ページリロード後の履歴反映テスト
  - _要件: 1.1, 1.2_

- [ ] 11.3 API障害時のフォールバックテスト
  - 500エラー時のプルダウン非表示テスト
  - 通常のテキスト入力継続可能性のテスト
  - エラーUI通知が表示されないことのテスト
  - _要件: 8.1, 8.3, 11.2_

## Phase 6: パフォーマンス検証と最適化

- [ ] 12. パフォーマンステストの実施
- [ ] 12.1 Cosmos DB RU/s消費検証
  - GET /api/player-names RU/s測定（目標: 3 RU/s以内）
  - POST /api/player-names RU/s測定（目標: 3 RU/s以内）
  - レスポンスヘッダー`x-ms-request-charge`の確認
  - _要件: 9.1, 9.2_

- [ ] 12.2 フロントエンドキャッシュ効果検証
  - 同一セッション内の複数フォーカス時のAPI呼び出し回数測定
  - キャッシュによるAPI呼び出し削減効果の確認（目標: 初回のみ呼び出し）
  - _要件: 9.4_

- [ ] 13. 統合テストとシステムテスト
- [ ] 13.1 API統合テストの実施
  - GET → POST → GETフロー検証（保存後の反映確認）
  - 41件保存時の40件制限検証
  - ローカルCosmos DBエミュレーターでの実テーブル接続検証
  - _要件: 1.4, 2.1, 2.3_

- [ ] 13.2 フロントエンド統合テストの実施
  - プレイヤー名入力フィールドフォーカス → `<datalist>`表示の検証
  - `<datalist>`から名前選択 → 入力フィールド設定の検証
  - ゲームリセット → 名前保存API呼び出しの検証
  - _要件: 4.1, 4.3, 1.1_

## Phase 7: 最終検証と実装完了処理

- [ ] 14. 後方互換性の検証
  - 既存のゲームタイマー機能（タイマー、ターン管理、ゲームコントロール）への影響がないことを確認
  - API障害時の通常テキスト入力モードでの完全動作確認
  - デフォルト名のままゲームプレイ可能であることの確認
  - _要件: 11.1, 11.2, 11.3_

- [ ] 15. 実装完了処理を実施する
- [ ] 15.1 全テスト結果の確認
  - 全てのユニットテストが成功していることを確認
  - 全てのE2Eテストが成功していることを確認
  - エラーや予期しない動作が発生しないことを確認

- [ ] 15.2 spec.json更新とコミット作成
  - spec.jsonのphaseを"implementation-done"に更新
  - tasks.mdの全タスクをチェック済み[x]に更新
  - 詳細なコミットメッセージを作成（実装内容、テスト結果含む）
  - Gitコミット作成（実装完了の最終コミット）
