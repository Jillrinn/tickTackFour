# Requirements Document

## はじめに

プレイヤー名永続化機能は、ユーザーが過去に使用したプレイヤー名をサーバーサイドで保存・再利用できるようにする機能です。この機能により、ゲームを開始するたびに同じプレイヤー名を手動で入力する手間を省き、より快適なユーザー体験を提供します。

Azure Functions APIとCosmos DB Table APIを活用してプレイヤー名の履歴を永続化し、プルダウン選択による素早い名前入力を可能にします。現在のデフォルト名（「プレイヤー1」など）は維持しつつ、使用済みの名前を履歴から選択できる柔軟なUI設計を目指します。

## 要件

### 要件1: プレイヤー名履歴のサーバーサイド保存

**目的:** ユーザーとして、過去に使用したプレイヤー名をサーバーに保存し、異なるデバイスやブラウザからでも履歴を参照できるようにしたい

#### 受け入れ基準

1. WHEN ユーザーがゲームを開始し、少なくとも1人のプレイヤー名をデフォルト値から変更した状態でゲームをリセットした THEN ゲームタイマーシステム SHALL 変更されたプレイヤー名をバックエンドAPIに送信し、Cosmos DB Table APIに保存する

2. WHEN ユーザーがゲームを開始し、少なくとも1人のプレイヤー名をデフォルト値から変更した状態でブラウザを閉じた THEN ゲームタイマーシステム SHALL 変更されたプレイヤー名をバックエンドAPIに送信し、Cosmos DB Table APIに保存する

3. WHEN プレイヤー名が保存される THEN バックエンドAPI SHALL 重複する名前を排除し、ユニークな名前のみをCosmos DBに保持する

4. WHEN プレイヤー名が保存される AND 保存済みの名前数が最大履歴数（20件）を超える THEN バックエンドAPI SHALL 最も古い名前を削除し、最新の名前を保存する

5. WHEN プレイヤー名が空文字列またはデフォルト名（「プレイヤー1」など）である THEN フロントエンド SHALL その名前をバックエンドAPIに送信しない

### 要件2: プレイヤー名履歴API

**目的:** システム管理者として、プレイヤー名履歴を管理するためのRESTful APIエンドポイントを提供したい

#### 受け入れ基準

1. WHERE バックエンドAPI THE ゲームタイマーシステム SHALL GET `/api/player-names` エンドポイントを提供し、保存されたプレイヤー名履歴を返す

2. WHEN GET `/api/player-names` が呼び出される THEN バックエンドAPI SHALL Cosmos DB Table APIから最新20件のプレイヤー名を取得し、最新順（新しい順）にソートして返す

3. WHERE バックエンドAPI THE ゲームタイマーシステム SHALL POST `/api/player-names` エンドポイントを提供し、新しいプレイヤー名を保存する

4. WHEN POST `/api/player-names` が呼び出される AND リクエストボディに有効なプレイヤー名が含まれる THEN バックエンドAPI SHALL 名前をCosmos DB Table APIに保存し、成功レスポンスを返す

5. WHEN POST `/api/player-names` が呼び出される AND リクエストボディが無効である（空文字列、null、長すぎる名前など） THEN バックエンドAPI SHALL 400 Bad Requestエラーを返す

6. WHEN APIエンドポイントが呼び出される AND Cosmos DBへの接続が失敗する THEN バックエンドAPI SHALL 500 Internal Server Errorを返し、エラーをログに記録する

### 要件3: Cosmos DB Table APIデータスキーマ

**目的:** システム管理者として、Cosmos DB Table APIに効率的なデータスキーマを設計することで、パフォーマンスとコスト効率を最適化したい

#### 受け入れ基準

1. WHERE Cosmos DB Table API THE バックエンドAPI SHALL テーブル名 "PlayerNames" を使用してプレイヤー名履歴を保存する

2. WHERE Cosmos DB Table API THE バックエンドAPI SHALL PartitionKey として固定値（例: "global"）を使用し、全プレイヤー名を単一パーティションに保存する

3. WHERE Cosmos DB Table API THE バックエンドAPI SHALL RowKey としてタイムスタンプベースのユニークID（例: ISO 8601逆順 + GUID）を使用する

4. WHEN プレイヤー名エンティティが保存される THEN バックエンドAPI SHALL 以下のプロパティを含む:
   - PartitionKey: 固定値（"global"）
   - RowKey: タイムスタンプベースのユニークID
   - PlayerName: プレイヤー名（文字列）
   - CreatedAt: 作成日時（ISO 8601形式）
   - Timestamp: Cosmos DB自動生成タイムスタンプ

5. WHEN プレイヤー名を取得する THEN バックエンドAPI SHALL RowKey の逆順ソート（最新順）でクエリを実行し、最大20件を取得する

### 要件4: プレイヤー名の履歴選択UI

**目的:** ユーザーとして、過去に使用した名前をプルダウンから選択できるようにすることで、素早く名前を設定したい

#### 受け入れ基準

1. WHEN ユーザーがプレイヤー名入力フィールドをフォーカスする OR クリックする THEN フロントエンド SHALL バックエンドAPI（GET `/api/player-names`）からプレイヤー名履歴を取得し、プルダウン形式で表示する

2. WHEN プレイヤー名履歴プルダウンが表示される THEN フロントエンド SHALL 取得した名前を最新順（新しい順）に並べて表示する

3. WHEN ユーザーがプルダウンから名前を選択する THEN フロントエンド SHALL 選択された名前をそのプレイヤーの名前フィールドに設定する

4. WHEN プレイヤー名履歴が存在しない（初回利用時など） OR API呼び出しが失敗した THEN フロントエンド SHALL プルダウンを表示せず、通常のテキスト入力のみを提供する

5. WHEN ユーザーがプルダウンを開いた状態で、他の場所をクリックする OR フォーカスを外す THEN フロントエンド SHALL プルダウンを自動的に閉じる

6. WHEN ユーザーがプレイヤー名入力フィールドに直接文字を入力する THEN フロントエンド SHALL プルダウンをフィルタリングし、入力文字に部分一致する名前のみを表示する

### 要件5: デフォルト名の維持

**目的:** システム管理者として、既存のデフォルト名生成ロジック（「プレイヤー1」など）を維持することで、既存機能との互換性を保ちたい

#### 受け入れ基準

1. WHEN ユーザーが新しいゲームを開始する THEN フロントエンド SHALL 各プレイヤーに現在と同じデフォルト名（「プレイヤー1」、「プレイヤー2」など）を設定する

2. WHEN プレイヤー人数が変更される AND 新しいプレイヤーが追加される THEN フロントエンド SHALL 新しいプレイヤーに適切な番号のデフォルト名を設定する

3. WHEN ゲームがリセットされる THEN フロントエンド SHALL 全てのプレイヤー名をデフォルト名にリセットする

### 要件6: UI統合とユーザビリティ

**目的:** ユーザーとして、プレイヤー名の保存・選択が直感的で邪魔にならないUIで実現されることで、スムーズなゲーム体験を得たい

#### 受け入れ基準

1. WHEN プレイヤー名履歴プルダウンが表示される THEN フロントエンド SHALL 現在のUI（GameTimerコンポーネント）内に統合されたプルダウンUIを提供する

2. WHEN プレイヤー名が保存される THEN フロントエンド SHALL ユーザーに明示的な保存操作を要求せず、自動的にバックグラウンドでバックエンドAPIに送信する

3. WHEN ユーザーがプルダウンをキーボードで操作する THEN フロントエンド SHALL 矢印キー（↑↓）での選択とEnterキーでの確定をサポートする

4. WHEN プルダウンが表示される THEN フロントエンド SHALL 各履歴項目にマウスホバー時のハイライト効果を提供する

5. WHEN プレイヤー名入力フィールドにフォーカスがある THEN フロントエンド SHALL プルダウンの開閉状態を視覚的に示すインジケーター（矢印アイコンなど）を表示する

6. WHEN API呼び出しが進行中である THEN フロントエンド SHALL ローディングインジケーターまたはスピナーを表示してユーザーに待機状態を通知する

### 要件7: レスポンシブ対応

**目的:** ユーザーとして、スマートフォンやタブレットでもプレイヤー名履歴を快適に選択できるようにしたい

#### 受け入れ基準

1. WHEN ユーザーがモバイルデバイス（画面幅768px以下）でプルダウンを開く THEN フロントエンド SHALL タッチ操作に最適化された十分なタップ領域（最低44px高さ）を持つプルダウン項目を表示する

2. WHEN プルダウンがモバイルデバイスで表示される AND 画面スペースが限られている THEN フロントエンド SHALL プルダウンの最大高さを制限し、スクロール可能にする

3. WHEN ユーザーがタブレットまたはPCで使用する THEN フロントエンド SHALL マウス操作とキーボード操作の両方に対応したプルダウンUIを提供する

### 要件8: エラーハンドリングと回復性

**目的:** システム管理者として、ネットワークエラーやAPI障害に適切に対処することで、システムの安定性とユーザー体験を保ちたい

#### 受け入れ基準

1. WHEN GET `/api/player-names` が呼び出される AND ネットワークエラーが発生する THEN フロントエンド SHALL エラーを無視し、プルダウンを表示せずに通常のテキスト入力のみを提供する

2. WHEN POST `/api/player-names` が呼び出される AND ネットワークエラーが発生する THEN フロントエンド SHALL エラーをログに記録し、保存処理を諦めるが、アプリケーションの動作は継続する

3. WHEN バックエンドAPIが500エラーを返す THEN フロントエンド SHALL ユーザーに控えめなエラー通知を表示し、通常のテキスト入力は継続可能にする

4. WHEN バックエンドAPIのレスポンスが5秒以内に返らない THEN フロントエンド SHALL リクエストをタイムアウトし、通常のテキスト入力モードにフォールバックする

5. WHEN Cosmos DBへの書き込みが失敗する（容量制限、RU/s制限など） THEN バックエンドAPI SHALL エラーをログに記録し、適切なHTTPステータスコード（503 Service Unavailable）を返す

6. WHEN Cosmos DBからの読み込みが失敗する THEN バックエンドAPI SHALL エラーをログに記録し、空の配列を返してフロントエンドの動作を継続させる

### 要件9: パフォーマンスとコスト最適化

**目的:** システム管理者として、Azure無料層の制限内で効率的に運用することで、コスト0円での永続的な運用を実現したい

#### 受け入れ基準

1. WHERE Cosmos DB操作 THE バックエンドAPI SHALL 1回のGET操作で最大2.5 RU/s以内、1回のPOST操作で最大3 RU/s以内に抑える

2. WHEN プレイヤー名履歴を取得する THEN バックエンドAPI SHALL Cosmos DB Table APIのクエリを単一パーティション内に制限し、クロスパーティションクエリを回避する

3. WHEN プレイヤー名を保存する THEN フロントエンド SHALL デバウンス処理（最低3秒間隔）を実装し、連続したAPI呼び出しを抑制する

4. WHEN GET `/api/player-names` が呼び出される THEN フロントエンド SHALL レスポンスをメモリ内にキャッシュし、同じセッション内での重複リクエストを回避する

5. WHERE Azure Functions THE バックエンドAPI SHALL Consumption Planの無料枠（月100万リクエスト）内で運用可能な設計を採用する

### 要件10: データバリデーションとセキュリティ

**目的:** システム管理者として、不正なデータや悪意のある入力からシステムを保護したい

#### 受け入れ基準

1. WHEN POST `/api/player-names` が呼び出される THEN バックエンドAPI SHALL プレイヤー名の長さを検証し、1文字以上50文字以下の範囲に制限する

2. WHEN POST `/api/player-names` が呼び出される THEN バックエンドAPI SHALL プレイヤー名に含まれる特殊文字をサニタイズし、HTML/JavaScriptインジェクションを防止する

3. WHEN バックエンドAPIがリクエストを受信する THEN バックエンドAPI SHALL Content-Type: application/json であることを検証する

4. WHEN GET `/api/player-names` が呼び出される THEN バックエンドAPI SHALL CORSヘッダーを適切に設定し、許可されたオリジンからのリクエストのみを受け付ける

5. WHERE プレイヤー名データ THE バックエンドAPI SHALL 認証レイヤーなしで運用するが、レート制限（例: IP単位で1分間に30リクエスト）を実装してDDoS攻撃を軽減する

### 要件11: 後方互換性と移行

**目的:** システム管理者として、既存のゲームタイマー機能に影響を与えずに新機能を追加したい

#### 受け入れ基準

1. WHEN プレイヤー名永続化機能が有効化される THEN ゲームタイマーシステム SHALL 既存のタイマー機能、ターン管理、ゲームコントロールに一切影響を与えない

2. WHEN バックエンドAPIが利用不可能である THEN フロントエンド SHALL 通常のテキスト入力モードで完全に機能し、ゲームプレイに支障をきたさない

3. WHEN ユーザーがプレイヤー名永続化機能を使用しない THEN フロントエンド SHALL デフォルト名のまま通常通りゲームをプレイ可能にする
